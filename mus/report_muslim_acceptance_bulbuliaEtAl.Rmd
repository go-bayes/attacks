---
title: "How did the Christchurch Mosque Attacks Affect Attitudes to Muslims in New Zealand?"
description: |
author:
  - name: Joseph Bulbulia
    url: https://josephbulbulia.netlify.app
    affiliation: Victoria University of Wellington
    affiliation_url: https://www.wgtn.ac.nz
    orcid_id: 0000-0002-5861-2056
date: 2021-MAR-12
output:
  distill::distill_article:
    self_contained: false
    toc: true
    code_folding: true
bibliography: bib.bib
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  layout = "l-body-outset",
  fig.width = 12,
  fig.height = 15,
  collapse = TRUE,
  R.options = list(width = 60
  )
)
```

```{r libs, include=FALSE}
#libraries
library("tidyverse") # data wrangling
library("here") # file management
library("equatiomatic") # equations
library("lubridate") # working with dates
library("ggplot2") # graphs
library("ggthemes") #themes
library("ggpubr") # graphs
library("viridis") # colours
library("patchwork") # combine graphs
library("ggforce") # graphs
library("lme4") # multilevel estimation
library("geepack") # marginal models
library("easystats") # reporting
library("kableExtra") # tables
library("broom") # working with  models
library("broom.mixed") # mixed effects models
library("brms") # bayesian estimation
library("rstan") # backend brms
library("rstanarm") # graphing
library("cmdstanr") # backend brms
library("ipw") # inverse probability weighting
library("tidybayes") # workign with posterior probability distributions
library("bayesplot") # graphs
library("ggokabeito")   # color palette
library("gghalves")     #  half geoms
library("ggbeeswarm")   # Special distribution-shaped point jittering
library("emmeans") # estimate marginal means
library("table1") # tables /now with latex

# rstan options
rstan_options(auto_write = TRUE) # bayesian estimation
options(mc.cores = parallel::detectCores ()) # use all course
theme_set(theme_pubclean()) # nice theme
#theme_set(theme_classic())
```

```{r}
cite_packages()
```


```{r data, cache = TRUE}
#import data
library(report)
library(dplyr)
df <- readRDS(here::here("data", "df"))
```

We prepare data by selecting data from wave 2018 (years 2018-19) and wave 2019 (years 2019-20)


```{r danalysisdata, cache=TRUE}
# dataset for models
km <- df %>%
  dplyr::select(
    Id,
      Wave,
      Age,
      EthnicCats,
      Urban,
      Edu,
      Male,
      Pol.Orient,
      NZdep,
      GenCohort,
    TSCORE,
    # Warm.Overweight,
    # Warm.Elderly,
    # Warm.Mental-Illness,
    Warm.Muslims,
    # Warm.Immigrants,
    # Warm.Asians,
    # Warm.Refugees,
#     Warm.Maori,
#     Warm.NZEuro,
#     Warm.Indians,
#     Warm.Chinese,
#     Warm.Refugees,
#     Warm.Pacific,
#     Muslim,
    TSCORE,
    WSCORE, 
    YearMeasured,
    Religious
  ) %>%
dplyr::filter( Wave == 2018 & YearMeasured ==1 | Wave == 2019 & YearMeasured ==1 ) %>%
   droplevels() %>%
  group_by(Id)%>%
  filter(n() == 2) %>%
  dplyr::add_tally() %>%
  filter(n == 2 ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Attack = ifelse(TSCORE >= 3545, 1, 0)) %>%
  #dplyr::mutate(Attack2 = factor(ifelse(Attack == 1 & Wave ==2019, 3, Attack)))%>%
  # dplyr::mutate(daysAfter = as.integer(TSCORE - 3545),
  #               yearsAfter = daysAfter / 365) %>%
  dplyr::mutate(years = (TSCORE - min(TSCORE) / 365)) %>%
  #dplyr::mutate(mw_lead = lead(Warm.Muslims))%>%
  drop_na()
 
length(unique(km$Id))
```

How many 90 days after the attacks? 

```{r}
3545 + 90


ts<-df %>%
  dplyr::filter(YearMeasured == 1)  %>%
  dplyr::filter(Wave == 2018) %>%
  dplyr::filter(TSCORE >= 3545) %>%
  dplyr::filter(TSCORE <= 3635) %>%
  dplyr::select(Id, TSCORE, Warm.Muslims) %>%
  dplyr::filter(!is.na(Warm.Muslims)) 

length(unique(ts$Id))

  
# dplyr::mutate(Pre_PostATTACK = factor(ifelse(
  #   TSCORE >= 3545, "post_attack",
  #   "pre_attack"
  # )))%>%
  # dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, c("pre_attack","post_attack")))%>%


    

  
  
dm <- df %>%
  dplyr::filter(YearMeasured == 1)  %>%
  dplyr::filter(Wave == 2019 |
                  Wave == 2018 |
                  Wave == 2017 |
                  Wave == 2016 |
                  Wave == 2015|
                  Wave == 2014|
                  Wave == 2013|
                  Wave == 2012) %>%
  dplyr::group_by(Id) %>% filter(n() > 2) %>%
  dplyr::ungroup(Id)  %>%
  dplyr::select(Id, TSCORE, Warm.Maori)%>%
  dplyr::filter(!is.na(Warm.Maori)) %>%
  dplyr::mutate(
    wm_s = scale(Warm.Maori),
    days = as.integer(TSCORE),
    yr_0 = ((days - min(days)) / 365),
    yrs = (days / 365),
    yr_a = 3545/365,
  ) %>%
```



Participants

```{r}
km0<-km%>%
  mutate(Edu = as.numeric(Edu),
         Attack = as.factor(Attack))

levels(km0$Attack) <- c('Pre', 'Post')

km0$Warm.Muslims
x <- table1::table1(~ Warm.Muslims + Age + Male +Edu + EthnicCats  +  Religious + Pol.Orient + Urban + NZdep|Wave*Attack, data = km0, overall=FALSE)

t1kable(x, format ="latex")
```


```{r}
# km2$id <-as.factor(km2$Id)
# km2$wave <-as.numeric(km2$Wave)-1
# km2$wave

# IPW - weidghts for treatment assignment 

w_ipw <- ipwtm(
  exposure = Attack,
  family = "binomial",
  link = "logit",
  # Time invariant 
  numerator =  ~ Male + GenCohort + Edu + EthnicCats,
  # Time invariant and non-invariant confounders
  denominator = ~ Male + GenCohort + Edu + EthnicCats + Religious + Pol.Orient + Urban + NZdep,
  id = Id,
  timevar = Wave,
  type = "first",
  data = as.data.frame(km)
)




#check no weights greater than 10
max(w_ipw$ipw.weights) # max is 1.189481

## add weights to data frame. 
km$Pol.Orient
library(tidyverse)
km <- km %>% 
  mutate(ipw = w_ipw$ipw.weights,
  Pol.Orient_S = scale(Pol.Orient))

# make Attack a factor
km$Attack <- as.factor(km$Attack) # mack attack a factor
```

### Frequentist estimation

We estimate a coefficient for attack of .26 [(95% CI = .22,.30]

```{r models, cache=TRUE}
library(lme4)

m0z <- lmer(Warm.Muslims ~ Attack  +  Wave + Pol.Orient_S + (1|Id),
           # weights = ipw,
           data = km)

parameters::model_parameters(m0z)%>%
  print_html()
```



We can estimate the expected means under three exposure conditions:

1. The entire population never experiences an attack. 

```{r models, cache=TRUE}
m00 <- lmer(Warm.Muslims ~ Attack + Pol.Orient_S  + Wave + (1|Id), 
           weights = ipw,
           data = km)

parameters::model_parameters(m00)%>%
  print_html()
p0 <- ggeffects::ggemmeans(m00,
                           terms = c( "Pol.Orient_S","Attack[0,1]","Wave[2018,2019]"))

p0

# for graph 
pl0 <- plot(p0 ) +  scale_y_continuous(limits = c(3,6)) +
  labs(title = "Counterfactual Outcome:\nno attack exposure") + theme_pubclean()
pl0



estimate_contrasts(
  m00,
  contrast = c("Wave","Attack"),
  at = c("Pol.Orient_S = -2"),
  fixed = NULL,
  transform = "none",
  ci = 0.95,
  adjust = "holm",
)

```

2. The entire population experiences the attack. 

```{r models, cache=TRUE}
p1 <-  ggeffects::ggemmeans(m0z,
                           terms = c("Wave[2018,2019]", "Attack[0,1]"))
p1
pl1<- plot(p1) + scale_y_continuous(limits = c(3,6)) + 
  labs(title = "Counterfactual Outcome:\neveryone exposed both waves") + theme_pubclean()
pl1
```

We can graph these two counterfactual scenarios
```{r models, cache=TRUE}
lmer_graph <-pl0+ pl1

ggsave(
  lmer_graph,
  path = here::here(here::here("_posts", "mus", "figs")),
  width = 10,
  height = 5,
  units = "in",
  filename = "fig-counterfactual.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)
```

### Marginal structural model 

We next replicate this study using a marginal structural model, with no differences in the expectation. 

```{r models, cache=TRUE}
## GEE
library(geepack)
m0 <- geeglm(
  Warm.Muslims ~ Attack + Wave,
  data = km,
  id = Id,
  family = "gaussian",
  weights = ipw,
  waves = Wave,
  corstr = "ar1"
)
summary(m0)

estimate_contrasts(
  m0,
  contrast = c("Wave","Attack"),
  at = NULL,
  fixed = NULL,
  transform = "none",
  ci = 0.95,
  adjust = "holm",
)
%>%
  slice(c(2.6,7) 
```


```{r models, cache=TRUE}

p0 <- ggeffects::ggemmeans(m0,
                           terms = c("Wave[2018]","Attack[0]"))
p0 <- ggeffects::ggemmeans(m0,
                           terms = c("Wave[2018,2019]","Attack[0,1]"))

p0

# for graph 
pl0 <- plot(p0 ) +  scale_y_continuous(limits = c(4,5)) +
  labs(title = "Counterfactual Outcome:\nno attack exposure") + theme_pubclean()
pl0
```

2. The entire population experiences the attack. 

```{r models, cache=TRUE}
p1 <-  ggeffects::ggemmeans(m0,
                           terms = c("Wave[2018,2019]", "Attack[1]"))
p1
pl1<- plot(p1) + scale_y_continuous(limits = c(4,5)) + 
  labs(title = "Counterfactual Outcome:\neveryone exposed both waves") + theme_pubclean()

```

We can graph these two counterfactual scenarios
```{r models, cache=TRUE}
marg <- pl0+ pl1 + plot_annotation(title ="Marginal Structural Model reproduces results from the Bayesian multilevel model.")


ggsave(
  marg,
  path = here::here(here::here("_posts", "mus", "figs")),
  width = 10,
  height = 5,
  units = "in",
  filename = "marginal_structural.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)

```


## Bayesian

We next replicate the multi-level model using a bayesian estimation. 

```{r}
library(tidybayes)    # Manipulate Stan objects in a tidy way

#m1 <-readRDS(here::here("_posts", "mus", "mods", "m1.rds"))
m1 <- brms::brm( 
  Warm.Muslims|weights(ipw) ~ Wave + Attack +  (1|Id), 
  data = km, 
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  backend = "cmdstanr",
  file = here::here("_posts", "mus", "mods", "m1.rds"))

#summary(m1)

library(lazerhawk)
blh_tab <- brms_SummaryTable(m1, panderize=F)
blh_tab
blh_tab %>%
   kable(booktabs = T, "latex", caption =  "Parameter for effect of attack on warmth to Muslims") %>%
    print()

ec <- modelbased::estimate_contrasts(
  m1,
  contrast = c("Attack","Wave"),
  at = "Attack",
  #fixed = NA,
  transform = "none",
  ci = 0.95,
  adjust = "holm",
)
#ec
saveRDS(ec, here::here("_posts", "mus", "mods", "ec.rds"))

tc<- as.data.frame(ec)
library(dplyr)
tc
tc%>%
  slice(c(1,3,5))%>%
  select(Level1,Level2,Difference,CI_low,CI_high,pd)%>%
  kbl(digits=3, booktabs=T, "latex")

pec<-readRDS( here::here("_posts", "mus", "mods", "ec.rds"))
```

```{r designtable,  tab.cap="\\label{tab:designtable}"}
km %>%
  group_by(Wave, Attack) %>%
  summarise(n = n()) %>%
  kbl(booktabs = T, "latex", caption = "Participant by exposure and wave") #%>%
  # kable_classic_2(c("striped", "hover"), full_width = TRUE) %>%
```


```{r eval=FALSE}
library(emmeans)
#d0 <-m1 %>% 
  emmeans(~ Wave,
          at = list(Attack = 0,
                    Wave = c("2018")),
          epred = TRUE,
          re_formulat = NA )
saveRDS(d0,  here::here("_posts", "mus", "mods", "d0.rds"))
d0 <- readRDS(here::here("_posts", "mus", "mods", "d0.rds"))
d0


#d1 <- m1 %>% emmeans(~ Wave,
          at = list(Attack = 1,
                    Wave = c("2018","2019")),
          epred = TRUE,
          re_formula = NA)

#saveRDS(d1,  here::here("_posts", "mus", "mods", "d1.rds"))
d1<- readRDS(here::here("_posts", "mus", "mods", "d1.rds"))
d1


d0 %>%
  contrast()

d1 %>%
  contrast()




# attack_effect_draws <- pred01 %>%
#   contrast() %>%
#   gather_emmeans_draws()
# attack_effect_draws


# graph
# ggplot(attack_effect_draws, aes(x = .value)) +
#   stat_halfeye(fill = palette_okabe_ito(order = 5)) +
#   labs(x = "Average marginal effect of attack", y = "Density") +
#   theme_clean() +
#   theme(legend.position = "bottom")

  
# parameters::parameters(
#   test = "pd",
#   priors = FALSE, 
#   effects = "all",
#   drop = TRUE,
#   group_level = FALSE,
#   diagnostic = "Rhat") %>%
#     mutate_if(is.numeric, ~ round(., 2)) %>%
#     mutate_all(funs(str_replace(., "b_", ""))) %>%
#     kable(booktabs = T, "latex", caption =  "Parameter estimates for model of Belief on Anxiety") %>%
#     print()

```


```{r}
#marg_eff_attack_0 <- m1 %>%
  epred_draws(newdata = expand.grid(Attack = c(0, 1),Wave = c("2018", "2019")),
              re_formula =NA)
           #   re_formula = NULL)  # or re_formula = ~ (1 | region)

#saveRDS(marg_eff_attack_0,  here::here("_posts", "mus", "mods", "marg_eff_attack_0.rds"))
marg_eff_attack_0 <- readRDS(here::here("_posts", "mus", "mods", "marg_eff_attack_0.rds"))


# Obtain contrasts
marg_eff_attack_0<- marg_eff_attack_0%>%
  filter(Attack == 1 & Wave ==2019| Attack == 1 & Wave ==2018|  Attack == 0 & Wave ==2018)
marg_eff_attack_0
plot_all <- ggplot(
  marg_eff_attack_0,
  aes(
    x = .epred,
    y = Wave,
    fill = as.factor(Attack)
  ) ) + 
#  scale_y_discrete(limits=rev) +
    stat_halfeye() +
    scale_fill_okabe_ito() +
    labs(
      x = "Predicted Warmth Response",
      y = NULL,
      fill = "Conterfactual Contrasts",
      subtitle = "Bayesian Posterior Simulations"
    ) +
    scale_x_continuous(limits=c(4.0,4.6)) +
    theme_pubclean() +
    theme(legend.position = "bottom"
    )
graph
#plot_all


grand_mean_ame <- m1 %>% 
  emmeans(~ Attack,
          epred = TRUE, re_formula = NA) %>% 
  contrast() %>% 
  gather_emmeans_draws()

#saveRDS(grand_mean_ame,  here::here("_posts", "mus", "mods", "grand_mean_ame.rds"))
grand_mean_ame <- readRDS(here::here("_posts", "mus", "mods", "grand_mean_ame.rds"))

# remove erro contrasts / 
grand_mean_ame_0 <- grand_mean_ame_0%>%
  filter(contrast != 0-0 |contrast != 1-0 )

grand_mean_ame_0

plot_all__ame <- ggplot(grand_mean_ame_0,
                                     aes(x = .value)) +
  stat_halfeye(slab_alpha = 0.75, fill = "grey") +
  scale_fill_okabe_ito(order = c(3, 4)) +
  labs(x = "Average marginal effect of attack on Warmth to Muslims",
       y = "Density") +
  #facet_wrap(vars(region)) +
  theme_classic() + 
  theme(legend.position = "bottom") + labs(title= "Average marginal effect of attack\non Warmth to Muslims")
plot_all__ame 
# Try
library(patchwork)
bayes_plots <- plot_all + plot_all__ame
bayes_plots

ggsave(
  bayes_plots,
  path = here::here(here::here("_posts", "mus", "figs")),
  width = 10,
  height = 5,
  units = "in",
  filename = "bayes_plots.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)
```




```{r pptimeline, cache=TRUE, fig.fullwidth = TRUE,  layout="l-body-outset", fig.width=12, fig.height=12, fig.cap="\\label{fig:pptimeline} Within-participant repeated measures covering the years before and following the attacks allow precise estimates of attitudinal change within-people (N = 11,481)."}
## timeline
rarep<-df%>%
  dplyr::filter(YearMeasured == 1) %>%
  dplyr::filter(Wave == 2018 | Wave == 2019) %>%
  dplyr::group_by(Id) %>% filter(n() == 2) %>%
  dplyr::filter(Wave == 2018 | Wave == 2019) %>%
  droplevels() %>%
  dplyr::ungroup(Id) %>%
  dplyr::mutate(timeline = make_date(year = 2009, month = 6, day = 30)+ TSCORE)%>%
  dplyr:::count(day = floor_date(timeline, "day"))%>%
  dplyr::mutate(Condition = factor(ifelse(day >="2018-06-18" & day < "2019-03-15", 0,
                                                 ifelse( day >="2019-03-15" & day < "2019-06-18",1 ,
                                                         2)),
                                                 labels= c("Control","Post-Attack", "Year following")))%>%
  arrange(day)
  #table(rarep$Condition)
# get data of change of baseline
#dates_vline1<- as.Date("2018-06-18")


# get attack date
dates_vline2<- as.Date("2019-03-15")
dates_vline3<- as.Date("2019-06-18")

# for line in a graph
dates_vline2b<-which(rarep$day %in% dates_vline2)
#dates_vline1b<-which(rarep$day %in% dates_vline1)
dates_vline3b<-which(rarep$day %in% dates_vline3)

lds2 <- ggplot(rarep, aes(day, n)) + geom_col(aes(fill = Condition)) + scale_x_date(date_labels = "%b/%Y",
                                                                                    limits = c(as.Date("2018-06-18"), as.Date("2020-10-15")))  +
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  geom_vline(xintercept = as.numeric(rarep$day[dates_vline2b]),
             col = "red",
             linetype = "dashed") +
  xlab("NZAVS Waves years 2018 - 2020 daily counts by condition") + ylab("Count of Responses")+
  theme_classic() +
  # annotate(
  #   "rect",
  #   xmin = as.Date("2017-08-25"),
  #   xmax = dates_vline1,
  #   ymin = 0,
  #   ymax = 900,
  #   alpha = 0
  # ) +
  annotate(
    "rect",
    xmin = dates_vline2,
    xmax = dates_vline3,
    ymin = 0,
    ymax = 900,
    alpha = .3,
    fill = "darkred"
  ) +
  # annotate(
  #   "rect",
  #   xmin = dates_vline1,
  #   xmax = dates_vline2,
  #   ymin = 0,
  #   ymax = 900,
  #   alpha = .3
  # ) +
  annotate(
    "rect",
    xmin = dates_vline3,
    xmax = as.Date("2020-10-15"),
    ymin = 0,
    ymax = 900,
    alpha = .05,
    fill = "red"
  ) +
  annotate(
    "text",
    x = as.Date("2018-10-15"),
    y = 1500,
    label = "Wave 10\npre-attacks"
  ) +
  # annotate(
  #   "text",
  #   x = as.Date("2018-01-15"),
  #   y = 980,
  #   label = "Wave 9
  #          baseline (control)"
  # ) +
  annotate(
    "text",
    x = as.Date("2019-05-15"),
    y = 1500,
    label = "Wave 10\npost\nattacks"
  ) +
  annotate(
    "text",
    x = as.Date("2020-02-15"),
    y = 1500,
    label = "Wave 11\nrepeated"
  ) +
  annotate(
    geom = "curve",
    x = as.Date("2018-02-15"),
    y = 950,
    xend = as.Date("2018-10-15"),
    yend = 950,
    curvature = -.3,
    arrow = arrow(length = unit(2, "mm"))
  ) +
  annotate(
    geom = "curve",
    x = as.Date("2018-02-15"),
    y = 950,
    xend = as.Date("2019-05-15"),
    yend = 950,
    curvature = -.3,
    arrow = arrow(length = unit(2, "mm"))
  ) +
  annotate("text",
           x = as.Date("2018-11-05"),
           y = 950,
           label = "Control") +
  annotate(
    geom = "curve",
    x = as.Date("2019-05-15"),
    y = 1000,
    xend = as.Date("2020-05-15"),
    yend = 1000,
    curvature = -.3,
    arrow = arrow(length = unit(2, "mm"))
  ) +
  annotate("text",
           x = as.Date("2019-06-05"),
           y = 950,
           label = "Attack") +
  annotate("text",
           x = as.Date("2020-07-30"),
           y = 1000,
           label = "Year\nFollowing") +
  annotate(
    geom = "curve",
    x = as.Date("2018-11-15"),
    y = 1000,
    xend = as.Date("2020-05-15"),
    yend = 1000,
    curvature = -.3,
    arrow = arrow(length = unit(2, "mm"))
  ) +
  theme(
    legend.position = "top",
    legend.text = element_text(size = 6),
    legend.title = element_text(color = "Black", size = 8)
  ) +
  scale_fill_viridis_d(option = "plasma")

### USE GRAPH OF TIMELINE
lds2


ggsave(
  lds2,
  path = here::here(here::here("_posts", "mus", "figs")),
  width = 10,
  height = 5,
  units = "in",
  filename = "timeline.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)
```

```{r}
## For intro
p1pp <- plot(p1,
            add.data = TRUE,
            dot.alpha = .05,
            jitter = .8) +
  ylab("Warmth to Muslims (1-7)") + labs(title = "Warm Muslims") +
  geom_hline(yintercept = 4.395, color = "green") +
  # scale_y_continuous(limits = c(1, 7)) +
  scale_colour_viridis_d() + xlab("Attack timeline") +
  # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") +
  theme_classic()
```


## Weights graph 

```{r}
km$attack <- as.numeric(km$Attack)-1

model_treatment_freq <- glm(attack ~  Male + GenCohort + Edu + EthnicCats + Religious + Pol.Orient + Urban + NZdep,
                            data = km,
                            family = binomial(link = "logit"))


# Step 2: Use the treatment model to calculate propensity scores, and
# Step 3: Use the propensity scores to calculate inverse probability of treatment weights
km_with_weights <- augment(model_treatment_freq, km,
                             type.predict = "response") %>%
  rename(propensity = .fitted) %>% 
  mutate(iptw = (attack / propensity) + ((1 - attack) / (1 - propensity)))

max(km_with_weights$iptw)
# Step 4: Use the IPTWs in a model that estimates the effect of treatment on outcome
model_outcome_freq <- lm(Warm.Muslims ~ Attack + Wave,
                         data = km_with_weights,
                         weights = iptw)

# Coefficient 
tidy(model_outcome_freq)




library(MetBrewer)
# ggplot() + 
#   geom_histogram(data = filter(km, Attack == 1), 
#                  bins = 50, aes(x = ipw), 
#                  fill = colorspace::lighten("darkorange", 0.5)) + 
#    geom_histogram(data = filter(km, Attack == 0), 
#                  bins = 50, aes(x = ipw, y = -..count..),
#                  fill = colorspace::lighten("darkgreen", 0.5)) +
#   geom_hline(yintercept = 0) + 
#   annotate(geom = "label", x = 0.8, y = 2000, label = "Treated", 
#            fill = colorspace::lighten("darkorange", 0.2), color = "white", hjust = 0) +
#   annotate(geom = "label", x = 0.8, y = -2000, label = "Untreated", 
#            fill = colorspace::lighten("darkgreen", 0.2), color = "white", hjust = 0) +
#   scale_y_continuous(label = abs) +
#  #coord_cartesian(xlim = c(0.1, 0.8), ylim = c(-10000, 10000)) +
#   labs(x = "Propensity", y = "Count") 


#  
ipwplot <- ggplot() + 
  geom_histogram(data = filter(km_with_weights, attack == 1), 
                 bins = 50, aes(x = propensity, weight = iptw), 
                 fill = colorspace::lighten("chocolate", 0.55)) + 
  geom_histogram(data = filter(km_with_weights, attack == 0), 
                 bins = 50, aes(x = propensity, weight = iptw, y = -..count..),
                  fill = colorspace::lighten("deepskyblue4", 0.55)) +
  geom_histogram(data = filter(km_with_weights, attack == 1), 
                 bins = 50, aes(x = propensity), 
                 fill = colorspace::lighten("chocolate", 0.1)) + 
  geom_histogram(data = filter(km_with_weights, attack == 0), 
                 bins = 50, aes(x = propensity, y = -..count..),
                 fill = colorspace::lighten("deepskyblue4", 0.1)) +
  annotate(geom = "label", x = 0.7, y = 1000, label = "Treated (actual)", 
          fill = colorspace::lighten("chocolate",.1), color = "white", hjust = 1) +
  annotate(geom = "label", x = 0.7, y = 3000, label = "Treated (IPTW\npseudo-population)", 
            fill = colorspace::lighten("chocolate",.35), color = "white", hjust = 1)+
  annotate(geom = "label", x = 0.7, y = -1000, label = "Untreated (actual)", 
          fill = colorspace::lighten("deepskyblue4", 0.1), color = "white", hjust = 1) +
  annotate(geom = "label", x = 0.7, y = -3000, label = "Untreated (IPTW\npseudo-population)", 
           fill = colorspace::lighten("deepskyblue4",  .35), color = "white", hjust = 1) +
  geom_hline(yintercept = 0, color = "white", size = 0.25) +
  scale_y_continuous(label = abs) +
 # coord_cartesian(xlim = c(0.1, 0.8), ylim = c(-80, 100)) +
  labs(x = "Propensity", y = "Count") + labs(title= "Comparison of propensity score\nand original response distributions")


ggsave(
  ipwplot,
  path = here::here(here::here("_posts", "mus", "figs")),
  width = 10,
  height = 5,
  units = "in",
  filename = "ipweightplot.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)


```




## 2017 as well

```{r danalysisdata, cache=TRUE}
ord_attack <- c("pre", "pst_w10","pst_w11")

 # table1::table1(~ Warm.Muslims|Wave, data = ts,transpose = TRUE)

  # dataset for models
km2 <- df %>%
  dplyr::select(
    Id,
    Age,
    Wave,
    EthnicCats,
    Urban,
    Edu,
    Male,
    Pol.Orient,
    NZdep,
    GenCohort,
    Urban,
    TSCORE,
    EthnicCats,
    # Warm.Overweight,
    # Warm.Elderly,
    # Warm.MentalIllness,
    Warm.Muslims,
    # Warm.Immigrants,
    # Warm.Asians,
    # Warm.Refugees,
    # Wave,
    # Warm.Maori,
    # Warm.NZEuro,
    # Warm.Indians,
    # Warm.Chinese,
    # Warm.Refugees,
    # Warm.Pacific,
    Muslim,
    TSCORE,
    WSCORE,
    YearMeasured,
    Religious
  ) %>%
  dplyr::filter(
      Wave == 2012 &
      YearMeasured == 1 |
      Wave == 2013 &
      YearMeasured == 1 |
      Wave == 2014 &
      YearMeasured == 1 |
      Wave == 2016 &
      YearMeasured == 1 |
      Wave == 2017 &
      YearMeasured == 1 |
      Wave == 2018 &
      YearMeasured == 1 |
      Wave == 2019 & 
        YearMeasured == 1
  ) %>% 
  droplevels() %>%
  arrange(Wave,Id) %>%
  group_by(Id) %>%
  dplyr::group_by(Id) %>% filter(n() > 6) %>%
  dplyr::add_tally() %>%
  filter(n == 7) %>%
  arrange(Wave,Id) %>%
  dplyr::mutate(Warm.Muslims_lag = lag(Warm.Muslims))%>%
  droplevels() %>%
  ungroup() %>%
  dplyr::mutate(Attack = ifelse(TSCORE >= 3545, 1, 0)) %>%
dplyr::mutate(Pre_PostATTACK = as.factor(ifelse(
  TSCORE >= 3545 & Wave == 2018,
  "pst_w10",
  ifelse(
    Wave == 2019,
    "pst_w11",
           "pre") )
)) %>%
dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, ord_attack)) %>%
  dplyr::group_by(Id) %>% filter(n() > 5) %>% 
  ungroup()%>%
  dplyr::mutate(dys = (TSCORE - min(TSCORE)))%>% 
  dplyr::mutate(yrs =  (dys/365))%>% 
  arrange(Id,Wave) %>%
  drop_na() 

length(unique(km2$Id))

w_ipw <- ipwtm(
  exposure = yrs,
  family = "gaussian",
  # Time invariant 
  numerator =  ~ Male + GenCohort + Edu + EthnicCats,
  # Time invariant and non-invariant confounders
  denominator = ~ Male + GenCohort + Edu + EthnicCats + Religious + Pol.Orient + Urban+NZdep,
  id = Id,
  timevar = Wave,
  corstr = "exchangeable",
  type = "all",
  data = as.data.frame(km2)
)




#check no weights greater than 10
max(w_ipw$ipw.weights) # max is 1.189481

## add weights to data frame. 
km$Pol.Orient
library(tidyverse)
km2 <- km2 %>% 
  mutate(ipw = w_ipw$ipw.weights)


library(splines)

m00 <- lmer(Warm.Muslims ~   bs(yrs) + Warm.Muslims_lag +   (1|Id), weights=ipw,
           data = km2)

parameters::model_parameters(m00)%>%
  print_html()
p0 <- ggeffects::ggemmeans(m00,
                           terms = c("yrs[all]"))
p0

# 
# # for graph 
pl0 <- plot(p0) +  scale_y_continuous(limits = c(3,6)) +
  labs(title = "Marginal Trend in Muslim Acceptance") + theme_pubclean()  +
  geom_vline(xintercept = 6.48, linetype="dashed", 
                color = "red", size=.5)
  
pl0


library(geepack)

# No difference
# m0 <- lmer(
#   Warm.Muslims ~  bs(yrs) + (1|Id),
#   data = km3
#  # weights = ipw,
# )


m0 <- geeglm(
  Warm.Muslims ~  bs(yrs),
  data = km3,
  id = Id,
  family = "gaussian",
  weights = ipw,
  waves = Wave,
  corstr = "ar1"
)
summary(m0)

max(km3$yrs)
p0 <- ggeffects::ggemmeans(m0,terms = c("yrs[all]"))

length(unique(km3$Id))
#
# # for graph 
marginal_trend <- plot(p0) +  scale_y_continuous(limits = c(3,6)) +
  labs(title = "Marginal Trend in Muslim Acceptance", subtitle=
         "N = 7920") + theme_pubclean()  +
  geom_vline(xintercept = 5.49, linetype="dashed", 
                color = "red", size=.5) + 
    geom_vline(xintercept = 5.49,
             col = "red",
             linetype = "dashed") + xlab("Years before attack") + ylab("Warmth to Muslims")
marginal_trend

ggsave(
  marginal_trend,
  path = here::here(here::here("_posts", "mus", "figs")),
  width = 10,
  height = 5,
  units = "in",
  filename = "marginal_trend.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)


km3 <- df %>%
  dplyr::select(
    Id,
    Age,
    Wave,
    EthnicCats,
    Urban,
    Edu,
    Male,
    Pol.Orient,
    NZdep,
    GenCohort,
    Urban,
    TSCORE,
    EthnicCats,
    # Warm.Overweight,
    # Warm.Elderly,
    # Warm.MentalIllness,
    Warm.Muslims,
    # Warm.Immigrants,
    # Warm.Asians,
    # Warm.Refugees,
    # Wave,
    # Warm.Maori,
    # Warm.NZEuro,
    # Warm.Indians,
    # Warm.Chinese,
    # Warm.Refugees,
    # Warm.Pacific,
    Muslim,
    TSCORE,
    WSCORE,
    YearMeasured,
    Religious
  ) %>%
  dplyr::filter(
      # Wave == 2012 &
      # YearMeasured == 1 |
      Wave == 2013 &
      YearMeasured == 1 |
      Wave == 2014 &
      YearMeasured == 1 |
      Wave == 2016 &
      YearMeasured == 1 |
      Wave == 2017 &
      YearMeasured == 1 |
      Wave == 2018 &
      YearMeasured == 1 
  ) %>% 
  droplevels() %>%
  arrange(Wave,Id) %>%
  group_by(Id) %>%
  dplyr::group_by(Id) %>% filter(n() > 4) %>%
  dplyr::add_tally() %>%
  filter(n == 5)%>%
  arrange(Wave,Id) %>%
  dplyr::mutate(Warm.Muslims_lag = lag(Warm.Muslims))%>%
  droplevels() %>%
  ungroup() %>%
  dplyr::mutate(Attack = ifelse(TSCORE >= 3545, 1, 0)) %>%
  dplyr::filter(Attack == 0) %>%
  dplyr::mutate(dys = (TSCORE - min(TSCORE)))%>% 
  dplyr::mutate(yrs =  (dys/365))%>% 
  arrange(Id,Wave) %>%
  drop_na() 

length(unique(km3$Id))


w_ipw <- ipwtm(
  exposure = yrs,
  family = "gaussian",
  # Time invariant 
  numerator =  ~ Male + GenCohort + Edu + EthnicCats,
  # Time invariant and non-invariant confounders
  denominator = ~ Male + GenCohort + Edu + EthnicCats + Religious + Pol.Orient + Urban+ NZdep,
  id = Id,
  timevar = Wave,
  corstr = "exchangeable",
  type = "all",
  data = as.data.frame(km3)
)




#check no weights greater than 10
max(w_ipw$ipw.weights) # max is 1.189481

## add weights to data frame. 
km$Pol.Orient
library(tidyverse)
km3 <- km3 %>% 
  mutate(ipw = w_ipw$ipw.weights)


max(km3$yrs)


library(geepack)
m0 <- geeglm(
  Warm.Muslims ~ bs(yrs),
  data = km3,
  id = Id,
  family = "gaussian",
  waves = Wave,
  weights = ipw,
  corstr = "ar1"
)
summary(m0)


p0 <- ggeffects::ggemmeans(m0,
                           terms = c("yrs[all]"))
p0

# 
# # for graph 
pl0 <- plot(p0) +  scale_y_continuous(limits = c(3,6)) +
  labs(title = "Effect of Time on Muslim Acceptance") + theme_pubclean()  +
  geom_vline(xintercept = 5.49, linetype="dashed", 
                color = "red", size=.5)
pl0

model_parameters(m0)%>%
  kbl(booktabs = T, "latex", caption = "Marginal Structural Model (splines) of Year Trend on Muslim Warmth prior to Attacks") #%>%

# 3545-1540 # rescakled date = 2005
```



## Imputation 

```{r}
library(tidyverse)
km4 <- df %>%
  dplyr::select(
    Id,
    Age,
    Wave,
    EthnicCats,
    Employed,
    Urban,
    Edu,
    Male,
    Pol.Orient,
    NZdep,
    Religious,
    GenCohort,
    Urban,
    TSCORE,
    # Warm.Overweight,
    # Warm.Elderly,
    # Warm.MentalIllness,
    Warm.Muslims,
    # Warm.Immigrants,
    # Warm.Asians,
    # Warm.Refugees,
    # Wave,
    # Warm.Maori,
    # Warm.NZEuro,
    # Warm.Indians,
    # Warm.Chinese,
    # Warm.Refugees,
    # Warm.Pacific,
    YearMeasured
  ) %>%
  dplyr::filter(
      # Wave == 2012 &
      # YearMeasured == 1 |
      # Wave == 2013 &
      # YearMeasured == 1 |
      # Wave == 2014 &
      # YearMeasured == 1 |
      # Wave == 2016 &
      # YearMeasured == 1 |
      # Wave == 2017 &
      # YearMeasured == 1 |
      Wave == 2018 &
      YearMeasured == 1 |
      Wave == 2019 &
      YearMeasured == 1 
  )%>% 
  droplevels() %>%
  dplyr::mutate(Edu = as.numeric(Edu))%>%
  arrange(Wave,Id) %>%
  dplyr::group_by(Id) %>% filter(n() > 1) %>%
  dplyr::add_tally() %>%
  filter(n == 2)%>%
  # dplyr::mutate(Warm.Muslims_lag = lag(Warm.Muslims))%>%
  # dplyr::mutate(Attack_lead = lead(Attack)) %>%
  # dplyr::mutate(Attack_lag = lag(Attack))%>%
  ungroup() %>%
  arrange(Wave,Id) %>%
  dplyr::mutate(Attack = factor((ifelse(TSCORE >= 3545, 1, 0)))) %>%
 # dplyr::filter(Attack == 0) %>%
  dplyr::mutate(dys = (TSCORE - min(TSCORE)))%>% 
  dplyr::mutate(Ys = Warm.Muslims, 
                As = Attack)%>%
  dplyr::mutate(yrs =  (dys/365))%>% 
  select(Id, Wave, yrs,Ys, As, Warm.Muslims,Attack, Age, EthnicCats, Edu, Employed, Urban, Male, GenCohort, Religious,Pol.Orient,Urban,NZdep)%>%
  arrange(Wave,Id) 

length(unique(km4$Id))
head(km4)


x <- table1::table1(~ Warm.Muslims + Age + Male + GenCohort + Edu + Employed + EthnicCats  +  Religious + Pol.Orient + NZdep + Urban|Wave*As, data = km4, overall=FALSE)

t1kable(x, format ="latex")

# # impute 
# library(Amelia)
# set.seed(1234)
# 
# km4<-as.data.frame(km4)
# imputed1 <- amelia(
#   km4, #dataset to impute
#   m = 10, # number of imputations
#   cs= c("Id"),
#   ts= c("yrs"),
#   noms = c(
#     "EthnicCats",
#     "Employed",
#     "Urban",
#     "Male",
#     "GenCohort",
#     "Religious"),
#  idvars=c("Wave"), # do not impute outcome
#   polytime = 3) #https://stackoverflow.com/questions/56218702/missing-data-warning-r
# #saveRDS(imputed,"imputed")



# create new data set
library(tidyverse)
kf  <-km4 %>%
  group_by(Id) %>%  # All ZEROS
  mutate(As = (ifelse(Wave==2018 & Attack == 1|Wave ==2019, 0, 
                     ifelse(Wave==2018 & Attack == 0, 1, Attack)))) %>%
  mutate(Ys = ifelse(Wave==2018 & Attack == 1|Wave ==2019, NA, 
                     ifelse(Wave==2018 & Attack == 0, NA, Warm.Muslims)))%>%
  ungroup() %>%
  arrange(Wave,Id) 


  
 # Test
table1::table1(~As + Ys | Wave, data = kf,overall=F )
table1::table1(~Attack + Warm.Muslims|Wave , data =kf, overall=F )
table1::table1(~As + Ys|Wave , data =km4 ,overall=F)

ka <- km4 %>%
bind_rows(kf)%>%
  arrange(Id,Wave) %>%
  mutate(As = as.factor(As)) %>%
  select(-c(Warm.Muslims,Attack))

head(ka)
ka
# Check 
table1::table1(~As + Ys | Wave, data = ka)

# looks good
km4%>%
  select(Id,Wave,As,Ys,yrs)

# impute missing data

# avoid collineraity
ka2<-ka%>%
  select(Id,Wave,As,Ys,Edu,EthnicCats,Employed,Urban,Male,GenCohort,Religious,Pol.Orient,NZdep, yrs)

library(Amelia)
ka2<-as.data.frame(ka2)
set.seed=1234
imputed <- amelia(
  ka2, #dataset to impute
  m = 10, # number of imputations
  cs= c("Id"),
  ts= c("yrs"),
  noms = c(
    "As",
    "EthnicCats",
    "Employed",
    "Urban",
    "Male",
    "GenCohort",
    "Religious"),
 idvars=c("Wave")) #, # do not impute outcome
#polytime = 3) #https://stackoverflow.com/questions/56218702/missing-data-warning-r
#saveRDS(imputed,here::here("_posts","mus","mods","imputed.rds"))
imputed<- readRDS(here::here("_posts","mus","mods","imputed.rds"))


imputed1<- imputed$imputations$imp1
imputed2<- imputed$imputations$imp2
imputed3<- imputed$imputations$imp3
imputed4<- imputed$imputations$imp4
imputed5<- imputed$imputations$imp5
imputed6<- imputed$imputations$imp6
imputed7<- imputed$imputations$imp7
imputed8<- imputed$imputations$imp8
imputed9<- imputed$imputations$imp9
imputed10<- imputed$imputations$imp10
str(imputed1)
hist(imputed1$Ys, col = "grey", border = "white")
hist(imputed2$Ys, col = "grey", border = "white")
hist(imputed3$Ys, col = "grey", border = "white")
hist(imputed4$Ys, col = "grey", border = "white")
hist(imputed5$Ys, col = "grey", border = "white")

table1::table1(~Ys| Wave*As, data = imputed1)
table1::table1(~Ys| Wave*As, data = imputed2)
table1::table1(~Ys| Wave*As, data = imputed3)
table1::table1(~Ys| Wave*As, data = imputed4)
table1::table1(~Ys| Wave*As, data = imputed5)


## Create weights for each imputed data set
m<-10
models<-NULL
for(i in 1:m) {
  models[[i]] <- lmer(Ys ~ As + Wave  + (1|Id), data=imputed$imputations[[i]])
}




pool_parameters(models)



pred <- ggeffects::ggemmeans(models[[1]], terms = c("Wave","As"))


plot(pred, facets = F) #  +  theme_classic() + ggtitle("") # title to be suppled
```

## FULL BAYES

```{r}
## FULL BAYES
m_direct <- brms::brm( 
  Ys ~ As +  Wave + (1|Id), 
  data = imputed1, 
  seed = 1234,
  warmup = 1000,
  iter = 2000,
  chains = 4,
  backend = "cmdstanr",
  file = here::here("_posts", "mus", "mods", "m_direct.rds"))



# Print Table
ouput <- tidy(m_direct)
str(ouput)
ouput
#output<- as.data.frame(ouput)


# ouput%>%
#   dplyr::select(-c("effect","component", "group"))


# t_results_m = m_direct %>% 
#   emmeans(~ As+Wave) %>% 
#   tidy(conf.int = TRUE) 
# 
# t_results_m
# t_results
# 
# saveRDS(t_results_m,  here::here("_posts", "mus", "mods", "t_results_m"))




t_results
saveRDS(t_results,  here::here("_posts", "mus", "mods", "t_results"))
library(lazerhawk)
brms_SummaryTable(m3a)

library(lazerhawk)
blh_tab <- brms_SummaryTable(m3a, panderize=F)
blh_tab
blh_tab %>%
   kable(booktabs = T, "latex", caption =  "Parameter for effect of attack on warmth to Muslims") %>%
    print()



## prior = c(prior(normal(0, 1), class = b)),

amelia.list <- list(imputed$imputations$imp1, 
                    imputed$imputations$imp2, 
                    imputed$imputations$imp3, 
                    imputed$imputations$imp4, 
                    imputed$imputations$imp5,
                    imputed$imputations$imp6, 
                    imputed$imputations$imp7, 
                    imputed$imputations$imp8, 
                    imputed$imputations$imp9, 
                    imputed$imputations$imp10)

#saveRDS(amelia.list,here::here("_posts","mus", "mods", "amelia.list"))
amelia.list<-readRDS("amelia.list")

m3b <- brms::brm_multiple(
  Ys ~ As *  Wave + (1|Id), 
  seed = 1234,
  warmup = 500,
  iter = 1000,
  chains = 4,
  backend = "cmdstanr",
  data = amelia.list,
  file = here::here("_posts", "mus", "mods", "m3ab.rds"))

summary(m3a)
```


### BAYES 2

```{r}


#### BRMS MODELS


#iter=10^6, thin =10
### connection to self. 
# library(lme4)
# library(merTools)
# with( dwat.out.SC$imputations$imp2, CrossTable(EthnicIndian,HinduPlusPuja))
# 
# # rm(modList)
# modList <- lmerModList(ConWork~ Time * HinduPlusPuja  + Time * EmotionalClose  + Age.C.decade + EthnicIndian + Male + (1|Id), data = dwat.out.SC$imputations)

# summary(modList)
#   print(modList)
# plot_model(modList$imp1)
# tab_model(modList$imp1)
# tab_model(modList$imp2)
# tab_model(modList$imp3)
# tab_model(modList$imp4)
# tab_model(modList$imp5)ggplot2::labs(colour = "factor1 (centred and normalized)")
# <- "Close to Diwali Dancer"
# ts<-ggpredict(modList$imp1, c("Time","HinduPlusPuja")) 
# plot(ts, facet=T)  +  labs(title = "Predicted Happiness Decay", y="Connected to Self")
# 
# 
# )


### omni-model  ### 
# 
# m3aa <- brms(Ys ~ As *  Wave + (1|Id), 
#   data = list(imputed$imputations$imp1), 
#  # seed = 1234,
#   warmup = 1000,
#   iter = 2000,
#   chains = 4,
#   backend = "cmdstanr",
#   file = here::here("_posts", "mus", "mods", "m3a.rds"))


marg_eff_attack_0a <- m_direct %>%
  epred_draws(newdata = expand.grid(As = c(0, 1),Wave = c("2018", "2019")),
              re_formula =NA)
           #   re_formula = NULL)  # or re_formula = ~ (1 | region)

#saveRDS(marg_eff_attack_0a,  here::here("_posts", "mus", "mods", "marg_eff_attack_0a.rds"))
marg_eff_attack_0a <- readRDS(here::here("_posts", "mus", "mods", "marg_eff_attack_0a.rds"))

marg_eff_attack_0a
# Obtain contrasts
# marg_eff_attack_0a<- marg_eff_attack_0a%>%
#   filter(As == 1 & Wave ==2019) #Attack == 1 & Wave ==2018|  Attack == 0 & Wave ==2018)

# marg_eff_attack_0
plot_all <- ggplot(
  marg_eff_attack_0a,
  aes(
    x = .epred,
    y = Wave,
    fill = as.factor(As)
  ) ) + 
#  scale_y_discrete(limits=rev) +
    stat_halfeye() +
    scale_fill_okabe_ito() +
    labs(
      x = "Predicted Warmth Response",
      y = "w2018(years 2018-2019); w2019 (years 2019-2020)",
      fill = "Conterfactual Contrasts",
      subtitle = "Bayesian posterior locations of potential outcomes"
    ) +
  #  scale_x_continuous(limits=c(4.0,4.6)) +
    theme_pubclean() +
    theme(legend.position = "bottom"
    )
plot_all
#plot_all


# not working
grand_mean_ame_a <- m3a %>%
  emmeans(~ As*Wave,
          epred = TRUE, re_formula = NA) %>%
  contrast() %>%
  gather_emmeans_draws() 

grand_mean_ame_a
#   filter(As == 1 & Wave ==2019) #Attack == 1 & Wave ==2018|  Attack == 0 & Wave ==2018)

#saveRDS(grand_mean_ame_a,  here::here("_posts", "mus", "mods", "grand_mean_ame_a.rds"))
#grand_mean_ame_a <- readRDS(here::here("_posts", "mus", "mods", "grand_mean_ame_a.rds"))

# remove erro contrasts / we don't observe 0 in year two 




plot_all__ame <- ggplot(grand_mean_ame_a,
                                     aes(x = .value)) +
  stat_halfeye(slab_alpha = 0.75, fill = "grey") +
  scale_fill_okabe_ito(order = c(3, 4)) +
  labs(x = "Average marginal effect of attack on warmth to Muslims",
       y = "Density") +
  #facet_wrap(vars(region)) +
  theme_classic() + 
  theme(legend.position = "bottom") + labs(title= "Marginal effect of attack on warmth to Muslims")
plot_all__ame 
# Try
library(patchwork)
bayes_plots_a <- plot_all + plot_all__ame + plot_annotation(tag_levels = 'a')
bayes_plots_a

ggsave(
  bayes_plots_a,
  path = here::here(here::here("_posts", "mus", "figs")),
  width = 10,
  height = 5,
  units = "in",
  filename = "bayes_plots_a.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)


# 
# blh_tab %>%
#    kable(booktabs = T, "latex", caption =  "Parameter for effect of attack on warmth to Muslims") %>%
#     print()
```

## MI Bayes

```{r}
## Run on my other mac, cmdstanr was ausing problems
gc()
m3ab <- readRDS(here::here("_posts", "mus", "mods", "m3ab.rds"))

summary(m3ab)

# Model was as below, called Rstand
# m3ab <- brms::brm_multiple(Ys ~ As *  Wave + (1|Id), 
#   seed = 1234,
#   warmup = 500,
#   iter = 1500,
#   chains = 4,
#  # backend = "cmdstanr",
#    data = imputed, 
#   file = here::here("_posts", "mus", "mods", "m3ab.rds"))



plot_bayes <- m3ab %>%
  emmeans( ~ As * Wave) %>%
  contrast(method = "pairwise") %>%
  gather_emmeans_draws() %>%
  ggplot(aes(x = .value, y = contrast)) +
  stat_halfeye()



marg_eff_attack_0ab <- m3ab %>%
  epred_draws(newdata = expand.grid(As = c(0, 1),Wave = c("2018", "2019")),
              re_formula =NA)

saveRDS(marg_eff_attack_0ab,  here::here("_posts", "mus", "mods", "marg_eff_attack_0ab.rds"))
#marg_eff_attack_0ab <- readRDS(here::here("_posts", "mus", "mods", "marg_eff_attack_0ab.rds"))


# Obtain contrasts

marg_eff_attack_0ab
plot_all <- ggplot(
  marg_eff_attack_0ab,
  aes(
    x = .epred,
    y = Wave,
    fill = as.factor(As)
  ) ) + 
#  scale_y_discrete(limits=rev) +
    stat_halfeye() +
    scale_fill_okabe_ito() +
    labs(
      x = "Predicted Warmth Response",
      y = "w2018(years 2018-2019); w2019 (years 2019-2020)",
      fill = "Conterfactual Contrasts",
      subtitle = "Bayesian posterior locations of potential outcomes"
    ) +
  #  scale_x_continuous(limits=c(4.0,4.6)) +
    theme_pubclean() +
    theme(legend.position = "bottom"
    )
plot_all
#plot_all


grand_mean_ame_ab <- m3ab %>% 
  emmeans(~ As*Wave,
          epred = TRUE, re_formula = NA) %>% 
  gather_emmeans_draws() 
   
grand_mean_ame_ab
grand_mean_ame_ab
saveRDS(grand_mean_ame_ab,  here::here("_posts", "mus", "mods", "grand_mean_ame_ab.rds"))
grand_mean_ame_ab <- readRDS(here::here("_posts", "mus", "mods", "grand_mean_ame_ab.rds"))
grand_mean_ame_ab%>%
  slice(10000)
# remove erro contrasts / we don't observe 0 in year two 
test <- grand_mean_ame_ab


plot_all__ame_ab <- ggplot(grand_mean_ame_ab,
                                     aes(x = .value)) +
  stat_halfeye(slab_alpha = 0.75, fill = "grey") +
  scale_fill_okabe_ito(order = c(3, 4)) +
  labs(x = "Average marginal effect of attack on warmth to Muslims",
       y = "Density") +
  #facet_wrap(vars(region)) +
  theme_classic() + 
  theme(legend.position = "bottom") + labs(title= "Marginal effect of attack on warmth to Muslims")
plot_all__ame_ab 
library(patchwork)
bayes_plots_a <- plot_all + plot_all__ame + plot_annotation(tag_levels = 'a')
bayes_plots_a

ggsave(
  bayes_plots_a,
  path = here::here(here::here("_posts", "mus", "figs")),
  width = 10,
  height = 5,
  units = "in",
  filename = "bayes_plots_a.jpg",
  device = 'jpeg',
  limitsize = FALSE,
  dpi = 1200
)





```








<!--   # dplyr::mutate(across( -->
<!--   #   c(Attack, -->
<!--   #     Age, -->
<!--   #     EthnicCats, -->
<!--   #     Urban, -->
<!--   #     Edu, -->
<!--   #     Male, -->
<!--   #     Pol.Orient, -->
<!--   #     Religious, -->
<!--   #     NZdep, -->
<!--   #     Warm.Overweight, -->
<!--   #     Warm.Elderly, -->
<!--   #     Warm.MentalIllness, -->
<!--   #     Warm.Muslims, -->
<!--   #     Warm.Immigrants, -->
<!--   #     Warm.Asians, -->
<!--   #     Warm.Refugees, -->
<!--   #     Warm.Maori, -->
<!--   #     Warm.NZEuro, -->
<!--   #     Warm.Indians, -->
<!--   #     Warm.Chinese, -->
<!--   #     Warm.Refugees, -->
<!--   #     Warm.Pacific -->
<!--   #   ), -->
<!--   #   list(lag = lag) -->
<!--   # )) %>% -->
<!--   # dplyr::mutate(across( -->
<!--   #   c( Attack, -->
<!--   #      Age, -->
<!--   #     EthnicCats, -->
<!--   #     Urban, -->
<!--   #     Edu, -->
<!--   #     Male, -->
<!--   #     Pol.Orient, -->
<!--   #     Religious, -->
<!--   #     NZdep, -->
<!--   #     Warm.Overweight, -->
<!--   #     Warm.Elderly, -->
<!--   #     Warm.MentalIllness, -->
<!--   #     Warm.Muslims, -->
<!--   #     Warm.Immigrants, -->
<!--   #     Warm.Asians, -->
<!--   #     Warm.Refugees, -->
<!--   #     Wave, -->
<!--   #     Warm.Maori, -->
<!--   #     Warm.NZEuro, -->
<!--   #     Warm.Indians, -->
<!--   #     Warm.Chinese, -->
<!--   #     Warm.Refugees, -->
<!--   #     Warm.Pacific -->
<!--   #   ), -->
<!--   #   list(lead = lead) -->
<!--   # )) %>% -->
<!--   ungroup() %>% -->

<!-- # filter(Wave == 2018)%>% -->
<!--   drop_na() -->

<!--  # dplyr::mutate( -->
<!--   #   cons_s = scale(Pol.Orient), -->
<!--   #   r_s = scale(Relid), -->
<!--   #   a_s = scale(Age) -->
<!--   # ) %>% -->

<!-- dim(km2) -->
<!-- length(unique(km2$Id)) -->
<!-- km2%>% -->
<!--   select(Id, Warm.Muslims,) %>% -->
<!--   head() -->
<!-- ``` -->

<!-- IPWeights -->

<!-- ```{r} -->
<!-- library("ipw") -->
<!-- km2 <- km2%>% -->
<!--   drop_na() -->
<!-- km2<-as.data.frame(km2) -->

<!-- km2$id <-as.factor(km2$Id) -->
<!-- km2$wave <-as.numeric(km2$Wave)-1 -->
<!-- km2$wave -->
<!-- length(unique(km2$Id)) -->

<!-- w_ipw <- ipwtm( -->
<!--   exposure = Attack, -->
<!--   family = "binomial", -->
<!--   link = "logit", -->
<!--   # Time invariant stuff -->
<!--   numerator =  ~ GenCohort + Edu + EthnicCats, -->
<!--   # All confounders -->
<!--   denominator = ~  GenCohort + Edu + EthnicCats + Religious + Pol.Orient + Urban + NZdep, -->
<!--   id = Id, -->
<!--   timevar = Wave, -->
<!--   type = "first", -->
<!--   data = as.data.frame(km2) -->
<!-- ) -->

<!-- #check no weights greater than 10 -->
<!-- max(w_ipw$ipw.weights) -->

<!-- ## -->
<!-- km2 <- km2 %>%  -->
<!--   mutate(ipw = w_ipw$ipw.weights) -->

<!-- ``` -->


<!-- ```{r eval=F} -->
<!-- # Test -->
<!-- km2%>% -->
<!--   select(Warm.Muslims_lag, Warm.Muslims_lead, Warm.Muslims, Attack, Attack_lag, Attack_lead, yearsAfter) -->
<!-- ``` -->

```{r}
library(ggdag)
library(tidyverse)
dg_simple <- dagify(
  Y ~  A + U,
  A ~ U,
 # L ~ U,
  Ys ~ Y,
  As ~ A,
 # Ls ~ L,
 # Ys ~ Y + U,
 # Ys ~ Ls,
 # As ~ Ls,
  exposure =  "As",
  outcome =   "Ys",
  latent = "U"
)%>%
  tidy_dagitty()

dg_simple %>%
  ggdag() + theme_dag_blank()

ggdag::ggdag_adjustment_set(dg_simple) + theme_dag_blank() +
labs(title = "") 

ggdag::ggdag_adjustment_set(dg_simple) + theme_dag_blank() +
labs(title = "") 
```





<!-- ```{r  dagpol, include = FALSE, eval = FALSE} -->
<!-- ## Use DAG to determine indicators on which to condition on, for causal inference.  -->
<!-- ## Note: for now, our focus is on prediction.  -->


<!-- dg_simple <- dagify( -->
<!--   y2 ~ y1 + a + y01 + t + U, -->
<!--   y1 ~ y01 + a + t + U, -->
<!--   y01 ~ t + c + U, -->
<!--   t ~ a,  -->
<!--   exposure =  "t", -->
<!--   outcome =   "y2", -->
<!--   latent = "U", -->
<!--    labels = c( -->
<!--     "y2" = "Warmth \n following year", -->
<!--     "y1" = "Warmth \n pre/post exposure", -->
<!--     "y01" = "Warmth\n baseline", -->
<!--     "a" = "pre/postattacks", -->
<!--     "t" = "time", -->
<!--     "U" = "Unmeasured Confounders", -->
<!--     "c" = "Measured\n confounders" -->
<!--   ) -->
<!-- )%>% -->
<!--   tidy_dagitty()  -->

<!-- # #%>% -->
<!-- #   control_for(c("y01,"t")) -->


<!-- ggdag::ggdag_adjustment_set(dg_simple,  use_labels = "label", text = FALSE) + theme_dag_blank() + -->
<!--   labs(title = "") -->
<!-- ``` -->

<!-- ```{r models, cache=TRUE} -->
<!-- library(lme4) -->
<!-- library(mgcv) -->
<!-- library(splines) -->
<!-- library(ggeffects) -->
<!-- # Check model -->
<!-- #parameters::model_parameters(m1) -->
<!-- ## 1.55 years to shooting -->
<!-- #parameters::model_parameters(m1)  estimate expected effect at day of shooting -->
<!-- #4.04 + .2 + .1*1.55 -->

<!-- head(km2) -->
<!-- ## models below -->
<!-- km2$Attack <- as.factor(km2$Attack) -->
<!-- #  -->
<!-- m1 <- lmer(Warm.Muslims ~ Wave + Attack +  (1|Id), weights = ipw, -->
<!--            data = km2) -->
<!-- summary(m1) -->


<!-- p1 <- ggeffects::ggemmeans(m1, -->
<!--                            terms = c("Wave[2019]","Attack[0]")) -->


<!-- p1 <- ggeffects::ggemmeans(m1, -->
<!--                            terms = c("Wave[2019]","Attack[0]")) -->


<!-- p1 <- ggeffects::ggemmeans(m1, -->
<!--                            terms = c("Wave[2018,2019]","Attack[0,1]")) -->
<!-- p1 -->

<!-- p1 <- ggeffects::ggpredict(m1, -->
<!--                            terms = c("Wave[2018], Attack[1]")) -->


<!-- p1p <- plot(p1, -->
<!--            # add.data = TRUE, -->
<!--             dot.alpha = .05, -->
<!--             jitter = .8) + -->
<!--   ylab("Warmth to Muslims (1-7)") + labs(title = "Warm Muslims") + -->
<!--   #geom_hline(yintercept = 4.395, color = "green") + -->
<!--   # scale_y_continuous(limits = c(1, 7)) + -->
<!--  # scale_colour_viridis_d() + xlab("Attack condition") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->
<!-- p1p -->

<!-- ## GEE -->
<!-- library(geepack) -->
<!-- m0 <- geeglm( -->
<!--   Warm.Muslims ~ Attack + Wave, -->
<!--   data = km2, -->
<!--   id = Id, -->
<!--   family = "gaussian", -->
<!--   weights = ipw, -->
<!--   waves = Wave, -->
<!--   corstr = "ar1" -->
<!-- ) -->

<!-- parameters::model_parameters(m0) %>% -->
<!--   print_html() -->


<!-- p0 <- ggeffects::ggpredict(m0, -->
<!--                            terms = c("Wave[2017,2018,2019]","Attack[0]")) -->

<!-- p0 -->

<!-- p0 <- ggeffects::ggpredict(m0, -->
<!--                            terms = c("Wave[2018,2019]","Attack[1]")) -->

<!-- p0 -->






<!-- p1p -->

<!-- ## For intro -->
<!-- p1pp <- plot(p1, -->
<!--             add.data = TRUE, -->
<!--             dot.alpha = .05, -->
<!--             jitter = .8) + -->
<!--   ylab("Warmth to Muslims (1-7)") + labs(title = "Warm Muslims") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   # scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->
<!-- ``` -->



<!-- ## Bayesian -->

<!-- ```{r} -->
<!-- library(tidybayes)    # Manipulate Stan objects in a tidy way -->
<!-- library(broom)        # Convert model objects to data frames -->
<!-- library(broom.mixed)   -->
<!-- b0 <- brm(  -->
<!--   Warm.Muslims|weights(ipw) ~ Wave + Attack +  (1|Id), -->
<!--   data = km2, -->
<!--   seed = 1234, -->
<!--   warmup = 1000, -->
<!--   iter = 3000, -->
<!--   chains = 4, -->
<!--   backend = "cmdstanr", -->
<!--   file = here::here("_posts", "mus", "mods", "b0.rds") -->
<!-- ) -->

<!-- #summary(b0) -->

<!-- #tidy(b0) -->
<!-- #parameters::model_parameters(b0, test = "p_direction") -->
<!-- #brms::ranef(b0) -->

<!-- library(emmeans) -->
<!-- pred0 <-b0 %>%  -->
<!--   emmeans(~ Wave, -->
<!--           at = list(Attack = 0, -->
<!--                     Wave = c("2018","2019")), -->
<!--           epred = TRUE) -->

<!-- pred0 -->
<!-- # Save -->
<!-- #saveRDS(pred0,  here::here("_posts", "mus", "mods", "pred0.rds")) -->
<!-- pred0 <- readRDS(here::here("_posts", "mus", "mods", "pred0.rds")) -->

<!-- pred01<- b0 %>% emmeans(~ Wave, -->
<!--           at = list(Attack = 1, -->
<!--                     Wave = c("2018","2019")), -->
<!--           epred = TRUE) -->


<!-- #saveRDS(pred01,  here::here("_posts", "mus", "mods", "pred01.rds")) -->
<!-- pred01<- readRDS(here::here("_posts", "mus", "mods", "pred01.rds")) -->
<!-- pred01 -->

<!-- pred02 <-b0 %>%  -->
<!--   emmeans(~ Wave, -->
<!--           at = list(Attack = 1, -->
<!--                     Wave = c("2018","2019")), -->
<!--           epred = TRUE) -->
<!-- saveRDS(pred02,  here::here("_posts", "mus", "mods", "pred02.rds")) -->
<!-- pred02<- readRDS(here::here("_posts", "mus", "mods", "pred02.rds")) -->

<!-- pred02 -->

<!-- pred02 %>% -->
<!--   contrast() -->


<!-- # USE -->




<!-- # graph  -->

<!-- library(emmeans) -->

<!-- # attack_effect_draws <- pred01 %>% -->
<!-- #   contrast() %>% -->
<!-- #   gather_emmeans_draws() -->
<!-- # attack_effect_draws -->


<!-- # graph -->
<!-- # ggplot(attack_effect_draws, aes(x = .value)) + -->
<!-- #   stat_halfeye(fill = palette_okabe_ito(order = 5)) + -->
<!-- #   labs(x = "Average marginal effect of attack", y = "Density") + -->
<!-- #   theme_clean() + -->
<!-- #   theme(legend.position = "bottom") -->



<!-- # parameters::parameters( -->
<!-- #   test = "pd", -->
<!-- #   priors = FALSE,  -->
<!-- #   effects = "all", -->
<!-- #   drop = TRUE, -->
<!-- #   group_level = FALSE, -->
<!-- #   diagnostic = "Rhat") %>% -->
<!-- #     mutate_if(is.numeric, ~ round(., 2)) %>% -->
<!-- #     mutate_all(funs(str_replace(., "b_", ""))) %>% -->
<!-- #     kable(booktabs = T, "latex", caption =  "Parameter estimates for model of Belief on Anxiety") %>% -->
<!-- #     print() -->

<!-- ``` -->


<!-- ```{r} -->

<!-- # marg_eff_attack <- b0 %>%  -->
<!-- #   epred_draws(newdata = expand.grid(Attack = c(0, 1), -->
<!-- #                                     Wave = c("2018","2019")),  -->
<!-- #               re_formula = NULL)  # or re_formula = ~ (1 | region) -->
<!-- marg_eff_attack<- readRDS(here::here("_posts", "mus", "mods", "marg_eff_attack.rds")) -->
<!-- marg_eff_attack -->

<!-- plot_all <- ggplot( -->
<!--   marg_eff_attack, -->
<!--   aes( -->
<!--     x = .epred, -->
<!--     y = Wave, -->
<!--     fill = as.factor(Attack) -->
<!--   ) ) + -->
<!--       scale_y_discrete(limits=rev) + -->
<!--     stat_halfeye() + -->
<!--     scale_fill_okabe_ito() + -->
<!--     labs( -->
<!--       x = "Predicted Warmth", -->
<!--       y = NULL, -->
<!--       fill = "Counterfactual responses", -->
<!--       subtitle = "Predictions under Attack/No-Attack counterfactuals" -->
<!--     ) + -->
<!--     theme_clean() + -->
<!--     theme(legend.position = "bottom") -->
<!-- plot_all -->

<!-- ggsave( -->
<!--   plot_all, -->
<!--   path = here::here(here::here("_posts", "mus", "figs")), -->
<!--   width = 10, -->
<!--   height = 5, -->
<!--   units = "in", -->
<!--   filename = "fig-counterfactual.jpg", -->
<!--   device = 'jpeg', -->
<!--   limitsize = FALSE, -->
<!--   dpi = 1200 -->
<!-- ) -->
<!-- ``` -->

<!-- Coefficient plots -->

<!-- ```{r} -->
<!-- parF1 <- parameters::model_parameters(b0)  -->
<!-- parF1 -->
<!-- plot(parF1,  sort = TRUE) +theme_lucid() #option --> -->
<!-- ``` -->





<!-- ## ALL Ethnicities -->

<!-- ```{r} -->

<!-- ```{r dataprep, cache=TRUE} -->
<!-- # prepare data -->
<!-- dt <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1)  %>% -->
<!--   dplyr::filter( -->
<!--     Wave == 2019 | -->
<!--       Wave == 2018 | -->
<!--       Wave == 2017 | -->
<!--       Wave == 2016 | -->
<!--       Wave == 2015 | -->
<!--       Wave == 2014 | -->
<!--       Wave == 2013 | -->
<!--       Wave == 2012 -->
<!--   ) %>% -->
<!--   dplyr::group_by(Id) %>% filter(n() > 2) %>% -->
<!--   dplyr::ungroup(Id)  %>% -->
<!--   dplyr::select(Id, TSCORE, Warm.Muslims) %>% -->
<!--   dplyr::filter(!is.na(Warm.Muslims)) %>% -->
<!--   dplyr::mutate( -->
<!--     wm_s = scale(Warm.Muslims), -->
<!--     days = as.integer(TSCORE), -->
<!--     yr_0 = ((days - min(days)) / 365), -->
<!--     yrs = (days / 365), -->
<!--     yr_a = 3545 / 365, -->
<!--   ) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = factor(ifelse( -->
<!--     TSCORE >= 3545, "post_attack", -->
<!--     "pre_attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, c("pre_attack", "post_attack"))) -->


<!-- ## below are dataframes used for the supplemental timelines in the appendix -->


<!-- # For Maori timline -->
<!-- dm <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1)  %>% -->
<!--   dplyr::filter( -->
<!--     Wave == 2019 | -->
<!--       Wave == 2018 | -->
<!--       Wave == 2017 | -->
<!--       Wave == 2016 | -->
<!--       Wave == 2015 | -->
<!--       Wave == 2014 | -->
<!--       Wave == 2013 | -->
<!--       Wave == 2012 -->
<!--   ) %>% -->
<!--   dplyr::group_by(Id) %>% filter(n() > 2) %>% -->
<!--   dplyr::ungroup(Id)  %>% -->
<!--   dplyr::select(Id, TSCORE, Warm.Maori) %>% -->
<!--   dplyr::filter(!is.na(Warm.Maori)) %>% -->
<!--   dplyr::mutate( -->
<!--     wm_s = scale(Warm.Maori), -->
<!--     days = as.integer(TSCORE), -->
<!--     yr_0 = ((days - min(days)) / 365), -->
<!--     yrs = (days / 365), -->
<!--     yr_a = 3545 / 365, -->
<!--   ) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = factor(ifelse( -->
<!--     TSCORE >= 3545, "post_attack", -->
<!--     "pre_attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, c("pre_attack", "post_attack"))) -->


<!-- # For Migrant timline -->
<!-- di <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1)  %>% -->
<!--   dplyr::filter( -->
<!--     Wave == 2019 | -->
<!--       Wave == 2018 | -->
<!--       Wave == 2017 | -->
<!--       Wave == 2016 | -->
<!--       Wave == 2015 | -->
<!--       Wave == 2014 | -->
<!--       Wave == 2013 | -->
<!--       Wave == 2012 -->
<!--   ) %>% -->
<!--   dplyr::group_by(Id) %>% filter(n() > 2) %>% -->
<!--   dplyr::ungroup(Id)  %>% -->
<!--   dplyr::select(Id, TSCORE, Warm.Immigrants) %>% -->
<!--   dplyr::filter(!is.na(Warm.Immigrants)) %>% -->
<!--   dplyr::mutate( -->
<!--     wm_s = scale(Warm.Immigrants), -->
<!--     days = as.integer(TSCORE), -->
<!--     yr_0 = ((days - min(days)) / 365), -->
<!--     yrs = (days / 365), -->
<!--     yr_a = 3545 / 365, -->
<!--   ) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = factor(ifelse( -->
<!--     TSCORE >= 3545, "post_attack", -->
<!--     "pre_attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, c("pre_attack", "post_attack"))) -->

<!-- dnz <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1)  %>% -->
<!--   dplyr::filter( -->
<!--     Wave == 2019 | -->
<!--       Wave == 2018 | -->
<!--       Wave == 2017 | -->
<!--       Wave == 2016 | -->
<!--       Wave == 2015 | -->
<!--       Wave == 2014 | -->
<!--       Wave == 2013 | -->
<!--       Wave == 2012 -->
<!--   ) %>% -->
<!--   dplyr::group_by(Id) %>% filter(n() > 2) %>% -->
<!--   dplyr::ungroup(Id)  %>% -->
<!--   dplyr::select(Id, TSCORE, Warm.NZEuro) %>% -->
<!--   dplyr::filter(!is.na(Warm.NZEuro)) %>% -->
<!--   dplyr::mutate( -->
<!--     wm_s = scale(Warm.NZEuro), -->
<!--     days = as.integer(TSCORE), -->
<!--     yr_0 = ((days - min(days)) / 365), -->
<!--     yrs = (days / 365), -->
<!--     yr_a = 3545 / 365, -->
<!--   ) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = factor(ifelse( -->
<!--     TSCORE >= 3545, "post_attack", -->
<!--     "pre_attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, c("pre_attack", "post_attack"))) -->


<!-- # For Refugee timline -->

<!-- drefugees <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1)  %>% -->
<!--   dplyr::filter( -->
<!--     Wave == 2019 | -->
<!--       Wave == 2018 | -->
<!--       Wave == 2017 | -->
<!--       Wave == 2016 | -->
<!--       Wave == 2015 | -->
<!--       Wave == 2014 | -->
<!--       Wave == 2013 | -->
<!--       Wave == 2012 -->
<!--   ) %>% -->
<!--   dplyr::group_by(Id) %>% filter(n() > 2) %>% -->
<!--   dplyr::ungroup(Id)  %>% -->
<!--   dplyr::select(Id, TSCORE, Warm.Refugees) %>% -->
<!--   dplyr::filter(!is.na(Warm.Refugees)) %>% -->
<!--   dplyr::mutate( -->
<!--     wm_s = scale(Warm.Refugees), -->
<!--     days = as.integer(TSCORE), -->
<!--     yr_0 = ((days - min(days)) / 365), -->
<!--     yrs = (days / 365), -->
<!--     yr_a = 3545 / 365, -->
<!--   ) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = factor(ifelse( -->
<!--     TSCORE >= 3545, "post_attack", -->
<!--     "pre_attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, c("pre_attack", "post_attack"))) -->


<!-- # For Chinese timline -->

<!-- dchinese <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1)  %>% -->
<!--   dplyr::filter( -->
<!--     Wave == 2019 | -->
<!--       Wave == 2018 | -->
<!--       Wave == 2017 | -->
<!--       Wave == 2016 | -->
<!--       Wave == 2015 | -->
<!--       Wave == 2014 | -->
<!--       Wave == 2013 | -->
<!--       Wave == 2012 -->
<!--   ) %>% -->
<!--   dplyr::group_by(Id) %>% filter(n() > 2) %>% -->
<!--   dplyr::ungroup(Id)  %>% -->
<!--   dplyr::select(Id, TSCORE, Warm.Chinese) %>% -->
<!--   dplyr::filter(!is.na(Warm.Chinese)) %>% -->
<!--   dplyr::mutate( -->
<!--     wm_s = scale(Warm.Chinese), -->
<!--     days = as.integer(TSCORE), -->
<!--     yr_0 = ((days - min(days)) / 365), -->
<!--     yrs = (days / 365), -->
<!--     yr_a = 3545 / 365, -->
<!--   ) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = factor(ifelse( -->
<!--     TSCORE >= 3545, "post_attack", -->
<!--     "pre_attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, c("pre_attack", "post_attack"))) -->


<!-- # For Indians timline -->


<!-- dindians <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1)  %>% -->
<!--   dplyr::filter( -->
<!--     Wave == 2019 | -->
<!--       Wave == 2018 | -->
<!--       Wave == 2017 | -->
<!--       Wave == 2016 | -->
<!--       Wave == 2015 | -->
<!--       Wave == 2014 | -->
<!--       Wave == 2013 | -->
<!--       Wave == 2012 -->
<!--   ) %>% -->
<!--   dplyr::group_by(Id) %>% filter(n() > 2) %>% -->
<!--   dplyr::ungroup(Id)  %>% -->
<!--   dplyr::select(Id, TSCORE, Warm.Indians) %>% -->
<!--   dplyr::filter(!is.na(Warm.Indians)) %>% -->
<!--   dplyr::mutate( -->
<!--     wm_s = scale(Warm.Indians), -->
<!--     days = as.integer(TSCORE), -->
<!--     yr_0 = ((days - min(days)) / 365), -->
<!--     yrs = (days / 365), -->
<!--     yr_a = 3545 / 365, -->
<!--   ) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = factor(ifelse( -->
<!--     TSCORE >= 3545, "post_attack", -->
<!--     "pre_attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, c("pre_attack", "post_attack"))) -->




<!-- # For Pacific Peoples timline -->

<!-- dpacific <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1)  %>% -->
<!--   dplyr::filter( -->
<!--     Wave == 2019 | -->
<!--       Wave == 2018 | -->
<!--       Wave == 2017 | -->
<!--       Wave == 2016 | -->
<!--       Wave == 2015 | -->
<!--       Wave == 2014 | -->
<!--       Wave == 2013 | -->
<!--       Wave == 2012 -->
<!--   ) %>% -->
<!--   dplyr::group_by(Id) %>% filter(n() > 2) %>% -->
<!--   dplyr::ungroup(Id)  %>% -->
<!--   dplyr::select(Id, TSCORE, Warm.Pacific) %>% -->
<!--   dplyr::filter(!is.na(Warm.Pacific)) %>% -->
<!--   dplyr::mutate( -->
<!--     wm_s = scale(Warm.Pacific), -->
<!--     days = as.integer(TSCORE), -->
<!--     yr_0 = ((days - min(days)) / 365), -->
<!--     yrs = (days / 365), -->
<!--     yr_a = 3545 / 365, -->
<!--   ) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = factor(ifelse( -->
<!--     TSCORE >= 3545, "post_attack", -->
<!--     "pre_attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, c("pre_attack", "post_attack"))) -->

<!-- drefugees <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1)  %>% -->
<!--   dplyr::filter( -->
<!--     Wave == 2019 | -->
<!--       Wave == 2018 | -->
<!--       Wave == 2017 | -->
<!--       Wave == 2016 | -->
<!--       Wave == 2015 | -->
<!--       Wave == 2014 | -->
<!--       Wave == 2013 | -->
<!--       Wave == 2012 -->
<!--   ) %>% -->
<!--   dplyr::group_by(Id) %>% filter(n() > 2) %>% -->
<!--   dplyr::ungroup(Id)  %>% -->
<!--   dplyr::select(Id, TSCORE, Warm.Refugees) %>% -->
<!--   dplyr::filter(!is.na(Warm.Refugees)) %>% -->
<!--   dplyr::mutate( -->
<!--     wm_s = scale(Warm.Refugees), -->
<!--     days = as.integer(TSCORE), -->
<!--     yr_0 = ((days - min(days)) / 365), -->
<!--     yrs = (days / 365), -->
<!--     yr_a = 3545 / 365, -->
<!--   ) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = factor(ifelse( -->
<!--     TSCORE >= 3545, "post_attack", -->
<!--     "pre_attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_PostATTACK = forcats::fct_relevel(Pre_PostATTACK, c("pre_attack", "post_attack"))) -->

<!-- ``` -->
<!-- ``` -->





<!-- ## Different Model  -->

<!-- ```{r models, cache=TRUE} -->
<!-- ## euro -->
<!-- m2 <- lmer(Warm.NZEuro  ~    Pre_PostATTACK + -->
<!--              (1 | Id) , -->
<!--            data = km2) -->

<!-- p2 <- ggeffects::ggpredict(m2, -->
<!--                            terms = "Pre_PostATTACK") -->


<!-- p2p <- plot(p2, -->
<!--             add.data = TRUE, -->
<!--             dot.alpha = .05, -->
<!--             jitter = .8) + -->
<!--   ylab("Warmth to NZ Europeans (1-7)") + labs(title = "Warm NZ Europeans") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   # scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + -->
<!--   xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->


<!-- # maori -->
<!-- m3 <- lmer(Warm.Maori ~     Pre_PostATTACK  + -->
<!--              (1 | Id) , -->
<!--            data = km2) -->
<!-- p3 <- ggeffects::ggpredict(m3, -->
<!--                            terms = "Pre_PostATTACK") -->


<!-- p3p <- plot(p3, -->
<!--             add.data = TRUE, -->
<!--             dot.alpha = .05, -->
<!--             jitter = .8) + -->
<!--   ylab("Warmth to Māori (1-7)") + labs(title = "Warmth to Māori") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   #  scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->

<!-- # migrants -->

<!-- m4 <- lmer(Warm.Immigrants ~    Pre_PostATTACK  + -->
<!--              (1 | Id) , -->
<!--            data = km2) -->

<!-- p4 <- ggeffects::ggpredict(m4, -->
<!--                            terms = "Pre_PostATTACK") -->

<!-- p4p <- plot(p4, -->
<!--             add.data = TRUE, -->
<!--             dot.alpha = .05, -->
<!--             jitter = .8) + -->
<!--   ylab("Warmth to Immigrants (1-7)") + labs(title = "Warmth to Immigrants") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   #  scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->


<!-- # asians -->

<!-- m5 <- lmer(Warm.Asians ~ Pre_PostATTACK + -->
<!--              (1 | Id) , -->
<!--            data = km2) -->

<!-- p5 <- ggeffects::ggpredict(m5, -->
<!--                            terms = "Pre_PostATTACK") -->

<!-- p5p <- plot(p5, -->
<!--             add.data = TRUE, -->
<!--             dot.alpha = .05, -->
<!--             jitter = .8) + -->
<!--   ylab("Warmth to Asians (1-7)") + labs(title = "Warmth to Asians") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   #  scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->


<!-- # indians -->

<!-- m6 <- lmer(Warm.Indians ~ Pre_PostATTACK + -->
<!--              (1 | Id) , -->
<!--            data = km2) -->

<!-- p6 <- ggeffects::ggpredict(m6, -->
<!--                            terms = "Pre_PostATTACK") -->

<!-- p6p <- plot(p6, -->
<!--             add.data = TRUE, -->
<!--             dot.alpha = .05, -->
<!--             jitter = .8) + -->
<!--   ylab("Warmth to Indians (1-7)") + labs(title = "Warmth to Indians") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   #  scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->


<!-- # Chinese -->

<!-- m7 <- lmer(Warm.Chinese  ~  Pre_PostATTACK  + -->
<!--              (1 | Id) , -->
<!--            data = km2) -->

<!-- p7 <- ggeffects::ggpredict(m7, -->
<!--                            terms = "Pre_PostATTACK") -->

<!-- p7p <- plot(p7, -->
<!--             add.data = TRUE, -->
<!--             dot.alpha = .05, -->
<!--             jitter = .8) + -->
<!--   ylab("Warmth to Chinese (1-7)") + labs(title = "Warmth to Chinese") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   #  scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->


<!-- ## pacific -->

<!-- m8 <- lmer(Warm.Pacific  ~  Pre_PostATTACK  + -->
<!--              (1 | Id) , -->
<!--            data = km2) -->


<!-- p8 <- ggeffects::ggpredict(m8, -->
<!--                            terms = "Pre_PostATTACK") -->

<!-- p8p <- plot(p8, -->
<!--             add.data = TRUE, -->
<!--             dot.alpha = .05, -->
<!--             jitter = .8) + -->
<!--   ylab("Warmth to Pacific (1-7)") + labs(title = "Warmth to Pacific Peoples") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   #  scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->


<!-- ## Elderly (contrast) -->

<!-- m9 <- lmer(Warm.Elderly  ~  Pre_PostATTACK + -->
<!--              (1 | Id), -->
<!--            data = km2) -->


<!-- p9 <- ggeffects::ggpredict(m9, -->
<!--                            terms = "Pre_PostATTACK") -->

<!-- p9p <- plot(p9, -->
<!--             add.data = TRUE, -->
<!--             dot.alpha = .05, -->
<!--             jitter = .8) + -->
<!--   ylab("Warmth to Elderly (1-7)") + labs(title = "Warmth to Elderly") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   #  scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->


<!-- ## mental illness -->

<!-- m10 <- lmer(Warm.MentalIllness  ~  Pre_PostATTACK + -->
<!--               (1 | Id) , -->
<!--             data = km2) -->

<!-- p10 <- ggeffects::ggpredict(m10, -->
<!--                             terms = "Pre_PostATTACK") -->

<!-- p10p <- plot(p10, -->
<!--              add.data = TRUE, -->
<!--              dot.alpha = .05, -->
<!--              jitter = .8) + -->
<!--   ylab("Warmth to the Mentally ill (1-7)") + labs(title = "Warmth to the Mentally ill") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   #  scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->


<!-- ### Overweight -->

<!-- m11 <- lmer(Warm.Overweight  ~ Pre_PostATTACK + -->
<!--               (1 | Id) , -->
<!--             data = km2) -->


<!-- p11 <- ggeffects::ggpredict(m11, -->
<!--                             terms = "Pre_PostATTACK") -->

<!-- p11p <- plot(p11, -->
<!--              add.data = TRUE, -->
<!--              dot.alpha = .05, -->
<!--              jitter = .8) + -->
<!--   ylab("Warmth to Overweight (1-7)") + labs(title = "Warmth to Overweight") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   #  scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->


<!-- ## Refugees -->

<!-- m12 <- lmer(Warm.Refugees  ~  Pre_PostATTACK + -->
<!--               (1 | Id) , -->
<!--             data = km2) -->

<!-- p12 <- ggeffects::ggpredict(m12, -->
<!--                             terms = "Pre_PostATTACK") -->

<!-- p12p <- plot(p12, -->
<!--              add.data = TRUE, -->
<!--              dot.alpha = .05, -->
<!--              jitter = .8) + -->
<!--   ylab("Warmth to Refugees (1-7)") + labs(title = "Warmth to Refugees") + -->
<!--   geom_hline(yintercept = 4.395, color = "green") + -->
<!--   #  scale_y_continuous(limits = c(1, 7)) + -->
<!--   scale_colour_viridis_d() + xlab("Attack timeline") + -->
<!--   # geom_vline(xintercept = c(2.8), colour = "red", linetype = "dashed") + -->
<!--   theme_classic() -->

<!-- ## For graphs -->
<!-- desc <- -->
<!--   'Large boost in Muslim acceptance following shootings; However Muslim acceptance still lags behind.' -->
<!-- p1a <- -->
<!--   p1p #+   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack', description = desc), colour = "red") + theme_classic() -->
<!-- p2a <- -->
<!--   p2p # +   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->
<!-- p3a <- -->
<!--   p3p # +   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->
<!-- p4a <- -->
<!--   p4p #+   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->

<!-- p5a <- -->
<!--   p5p #+   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->


<!-- p6a <- -->
<!--   p6p #+   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->

<!-- p7a <- -->
<!--   p7p #+   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->


<!-- p8a <- -->
<!--   p8p #+   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->

<!-- p9a <- -->
<!--   p9p #+   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->

<!-- p10a <- -->
<!--   p10p #+   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->

<!-- p11a <- -->
<!--   p11p #+   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->

<!-- p12a <- -->
<!--   p12p #+   ggforce::geom_mark_ellipse(aes(label = 'Pre/Post Attack')) + theme_classic() -->

<!-- lds3 <- -->
<!--   (p1a + -->
<!--      p4a + -->
<!--      p5a + -->
<!--      p6a + -->
<!--      p7a + -->
<!--      p12a) + -->
<!--   plot_annotation(tag_levels = 'a', -->
<!--                   title = "Attitudes to Muslims and Non-Pacific Minorities", -->
<!--                   subtitle = "pre/post attacks") + -->
<!--   plot_layout(guides = 'collect', ncol = 1) + -->
<!--   theme_classic() -->

<!-- lds4 <- -->
<!--   (p2a + -->
<!--      p3a + -->
<!--      p8a + -->
<!--      p9a + -->
<!--      p10a + -->
<!--      p11a) + plot_annotation(tag_levels = 'a', -->
<!--                              title = "Attitudes to contrast groups", -->
<!--                              subtitle = "Pacific/Maori/non-Ethnic minorities: pre/post attacks") +  plot_layout(guides = 'collect', ncol = 1) -->



<!-- # RESULTS BELOW -->
<!-- # parameters::model_parameters(m1) -->
<!-- # parameters::model_parameters(m2) -->
<!-- # parameters::model_parameters(m2) -->
<!-- # parameters::model_parameters(m2) -->
<!-- # parameters::model_parameters(m2) -->
<!-- # parameters::model_parameters(m2) -->
<!-- # parameters::model_parameters(m2) -->
<!-- # parameters::model_parameters(m2) -->
<!-- # parameters::model_parameters(m2) -->
<!-- # parameters::model_parameters(m11) -->
<!-- # parameters::model_parameters(m10) -->
<!-- # parameters::model_parameters(m11) -->
<!-- ``` -->


<!-- ```{r echo = FALSE} -->
<!-- if (!require(xaringanExtra)) { -->
<!--   devtools::install_github("gadenbuie/xaringanExtra") -->
<!-- } -->
<!-- ``` -->


<!-- ## Talk -->

<!-- Click [here](slides.html) to go to the lecture slides. -->

<!-- ```{r embed-xaringan, layout="l-body-outset"} -->
<!-- xaringanExtra::embed_xaringan(url = "slides.html", ratio = "16:9") -->
<!-- ``` -->


<!-- ## Summary -->

<!-- ```{r fig.fullwidth = TRUE, layout="l-body-outset", cache=TRUE, fig.cap="\\label{fig:muslimboost} Change in acceptance of Muslims following the Christchurch Mosque attacks March 15, 2019.  Green horizonal line indicates peak acceptance of Muslims, which occurred following the attacks (N = 11272, Years = 2017-2020, Source = New Zealand Attitudes and Values Study)"} -->
<!-- p1pp -->
<!-- ``` -->


<!-- - Following the Christchurch Mosque attacks, warmth towards Muslim grew. -->
<!-- - Despite this growth, warmth to Muslims lags behind all other groups (except overweight people.) -->
<!-- - Following the mosque attacks non-Pacific/Māori minority groups with Muslims also received a boost in warmth. -->
<!-- - The Muslim acceptance gap remains large.  -->


<!-- ## Introduction -->

<!-- We investigate warmth to Muslims before and after the 15 March 2019 mosque attacks in a nationally diverse longitudinal sample of New Zealanders (*N* = 11,272), and clarify how levels of warmth changed to Muslims and other groups.^[ -->
<!-- The New Zealand Attitudes and Values Study (NZAVS) is a nationally representative panel study that Prof Chris Sibley started in 2009 [@nzavs2021], which has measured over 65,000 New Zealanders (see [NZAVS](https://www.psych.auckland.ac.nz/en/about/new-zealand-attitudes-and-values-study.html)] -->

<!-- <aside> -->
<!-- The NZAVS measures tolerance using validated "affective thermometers" See [@sibley2020prejudice]. -->
<!-- </aside> -->

<!-- ### Findings -->

<!--   -   Following the attacks there was a substantial increase in warmth to Muslims (Figure \@ref(fig:graphsmodels)a) -->
<!--   -   Following the attacks, there was also a small boost in warmth to Immigrants (Figure \@ref(fig:graphsmodels)b), Asians (Figure \@ref(fig:graphsmodels)c), Indians (Figure \@ref(fig:graphsmodels)d), Chinese people (Figure \@ref(fig:graphsmodels)e), and Refugees (Figure \@ref(fig:graphsmodels)f.) -->
<!--   -  The boost in warmth was specific to Muslims and non-Pacific minorities  (Figure \@ref(fig:graphsmodels)a-f.) -->
<!--   -  Despite the post-attack boost in warmth to Muslims, warmth to Muslims still lags behind warmth to other groups. (Figure \@ref(fig:graphsmodels)a-f). -->
<!--   -  Whether the in boost to warmth to Muslims and ethnic groups associated with Muslims persists remains unclear.  -->


<!-- Muslims and groups non-Pacific ethnic minorities -->

<!-- ```{r  graphsmodels, fig.height = 75, fig.fullwidth = TRUE, layout="l-body-outset", cache=TRUE, fig.cap="\\label{fig:graphsmodels} Increase in Warmth to Muslims After Shootings (red-dashed line), however, the acceptance of Muslims lags behind other minority groups. Green horizonal line indicates peak acceptance of Muslims, (N = 11272, Years = 2017-2020, Source = New Zealand Attitudes and Values Study)", echo = FALSE} -->
<!-- lds3 -->
<!-- ``` -->


<!-- Contrast groups that are not associated with Muslims. -->

<!-- ```{r graphsmodels2, fig.height = 75, fig.fullwidth = TRUE,  layout="l-body-outset", cache=TRUE, fig.cap="\\label{fig:graphsmodels2} There is no evidence for substantial change in prejudice pre-post shootings among groups that are not associated with Muslims.  Green horizonal line indicates peak acceptance of Muslims, which occurred following the attacks (N = 11272, Years = 2017-2020, Source = New Zealand Attitudes and Values Study)", echo = FALSE} -->
<!-- lds4 -->
<!-- ``` -->




<!-- ### Importance of findings -->

<!--   -   Although the purpose of the Mosque attacks was to incite division, the attacks caused a strong boost in acceptance. -->
<!--   -   The reasons for the boost in Muslim acceptance are unclear. -->
<!-- <aside> -->
<!-- Speculating, the government's response, media's response [@shaver2017news], and non-Muslim church responses [@Shaver2016-fs] likely played a role in boosting Muslim acceptance. -->
<!-- </aside> -->
<!--   -   Whether growth in acceptance will be sustained remains unclear -->
<!--   -   Whether acceptance reverts to pre-shooting levels remains unclear. -->



<!-- ## Appendix 1: Design -->

<!-- Participants responded to waves 9, 10, and 11 of the New Zealand Attitudes and Values Study. In total there were `r length(unique(km2$Id))` participants who responded to all three waves. See Figure \@ref(fig:pptimeline), Table \@ref(tab:designtable) -->

<!-- ```{r designtable,  tab.cap="\\label{tab:designtable}"} -->
<!-- km2 %>% -->
<!--   select(Pre_PostATTACK) %>% -->
<!--   group_by(Pre_PostATTACK) %>% -->
<!--   summarise(n = n()) %>% -->
<!--   kbl(caption = "Participant numbers divided by condition: baseline, wave 10 pre/shootings, wave 10 post-shooting, and wave 11") %>% -->
<!--    kable_classic_2(c("striped", "hover"), full_width = TRUE) -->
<!-- ``` -->

<!-- ```{r pptimeline, cache=TRUE, fig.fullwidth = TRUE,  layout="l-body-outset", fig.width=12, fig.height=12, fig.cap="\\label{fig:pptimeline} Within-participant repeated measures covering the years before and following the attacks allow precise estimates of attitudinal change within-people (N = 11,481)."} -->
<!-- ## timeline -->
<!-- rarep<-df%>% -->
<!--   dplyr::filter(YearMeasured == 1) %>% -->
<!--   dplyr::filter(Wave == 2017 | Wave == 2018 | Wave == 2019) %>% -->
<!--   dplyr::group_by(Id) %>% filter(n() == 3) %>% -->
<!--   dplyr::filter(Wave == 2017 | Wave == 2018 | Wave == 2019) %>% -->
<!--   droplevels() %>% -->
<!--   dplyr::ungroup(Id) %>% -->
<!--   dplyr::mutate(timeline = make_date(year = 2009, month = 6, day = 30)+ TSCORE)%>% -->
<!--   dplyr:::count(day = floor_date(timeline, "day"))%>% -->
<!--   dplyr::mutate(Condition = factor(ifelse(day < "2018-06-18", -1,  -->
<!--                                           ifelse(day >="2018-06-18" & day < "2019-03-15", 0, -->
<!--                                                  ifelse( day >="2019-03-15" & day < "2019-06-18",1 ,  -->
<!--                                                          2))), -->
<!--                                                  labels= c("PRE-ATTACK Baseline wv9 N = 11,481","PRE-ATTACK CONTROL rep measure wv10: n = 8120","IMMEDIATE POST-ATTACK rep measure wv10: PostAttack n = 3361", "DELAY POST-ATTACK Repeated measure post attack 2019: N= 11,481")))%>% -->
<!--   arrange(day) -->
<!-- #table(rarep$Condition) -->
<!-- # get data of change of baseline -->
<!-- dates_vline1<- as.Date("2018-06-18") -->

<!-- table(km2$Pre_PostATTACK) -->

<!-- # get attack date -->
<!-- dates_vline2<- as.Date("2019-03-15") -->
<!-- dates_vline3<- as.Date("2019-06-18") -->

<!-- # for line in a graph -->
<!-- dates_vline2b<-which(rarep$day %in% dates_vline2) -->
<!-- dates_vline1b<-which(rarep$day %in% dates_vline1) -->
<!-- dates_vline3b<-which(rarep$day %in% dates_vline3) -->

<!-- lds2 <- ggplot(rarep, aes(day, n)) + geom_col(aes(fill = Condition)) + scale_x_date(date_labels = "%b/%Y", -->
<!--                                                                                     limits = c(as.Date("2017-08-25"), as.Date("2020-10-15")))  + -->
<!--   scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) + -->
<!--   geom_vline(xintercept = as.numeric(rarep$day[dates_vline2b]), -->
<!--              col = "red", -->
<!--              linetype = "dashed") + -->
<!--   xlab("NZAVS Waves years 2017 - 2020 daily counts") + ylab("Count of Responses")+ -->
<!--   theme_classic() + -->
<!--   annotate( -->
<!--     "rect", -->
<!--     xmin = as.Date("2017-08-25"), -->
<!--     xmax = dates_vline1, -->
<!--     ymin = 0, -->
<!--     ymax = 900, -->
<!--     alpha = 0 -->
<!--   ) + -->
<!--   annotate( -->
<!--     "rect", -->
<!--     xmin = dates_vline2, -->
<!--     xmax = dates_vline3, -->
<!--     ymin = 0, -->
<!--     ymax = 900, -->
<!--     alpha = .3, -->
<!--     fill = "darkred" -->
<!--   ) + -->
<!--   annotate( -->
<!--     "rect", -->
<!--     xmin = dates_vline1, -->
<!--     xmax = dates_vline2, -->
<!--     ymin = 0, -->
<!--     ymax = 900, -->
<!--     alpha = .3 -->
<!--   ) + -->
<!--   annotate( -->
<!--     "rect", -->
<!--     xmin = dates_vline3, -->
<!--     xmax = as.Date("2020-10-15"), -->
<!--     ymin = 0, -->
<!--     ymax = 900, -->
<!--     alpha = .05, -->
<!--     fill = "red" -->
<!--   ) + -->
<!--   annotate( -->
<!--     "text", -->
<!--     x = as.Date("2018-10-15"), -->
<!--     y = 980, -->
<!--     label = "Wave 10 -->
<!--            repeated pre-attacks" -->
<!--   ) + -->
<!--   annotate( -->
<!--     "text", -->
<!--     x = as.Date("2018-01-15"), -->
<!--     y = 980, -->
<!--     label = "Wave 9 -->
<!--            baseline (control)" -->
<!--   ) + -->
<!--   annotate( -->
<!--     "text", -->
<!--     x = as.Date("2019-04-30"), -->
<!--     y = 980, -->
<!--     label = "Wave 10 -->
<!--            repeated post attacks" -->
<!--   ) + -->
<!--   annotate( -->
<!--     "text", -->
<!--     x = as.Date("2020-02-15"), -->
<!--     y = 980, -->
<!--     label = "Wave 11 -->
<!--            repeated during the year following attacks" -->
<!--   ) + -->
<!--   annotate( -->
<!--     geom = "curve", -->
<!--     x = as.Date("2018-02-15"), -->
<!--     y = 750, -->
<!--     xend = as.Date("2018-10-15"), -->
<!--     yend = 750, -->
<!--     curvature = -.3, -->
<!--     arrow = arrow(length = unit(2, "mm")) -->
<!--   ) + -->
<!--   annotate( -->
<!--     geom = "curve", -->
<!--     x = as.Date("2018-02-15"), -->
<!--     y = 750, -->
<!--     xend = as.Date("2019-05-15"), -->
<!--     yend = 750, -->
<!--     curvature = -.3, -->
<!--     arrow = arrow(length = unit(2, "mm")) -->
<!--   ) + -->
<!--   annotate("text", -->
<!--            x = as.Date("2018-02-01"), -->
<!--            y = 750, -->
<!--            label = "0") + -->
<!--   annotate("text", -->
<!--            x = as.Date("2018-11-05"), -->
<!--            y = 750, -->
<!--            label = "+1") + -->
<!--   annotate( -->
<!--     geom = "curve", -->
<!--     x = as.Date("2019-05-15"), -->
<!--     y = 800, -->
<!--     xend = as.Date("2020-05-15"), -->
<!--     yend = 750, -->
<!--     curvature = -.3, -->
<!--     arrow = arrow(length = unit(2, "mm")) -->
<!--   ) + -->
<!--   annotate("text", -->
<!--            x = as.Date("2019-06-05"), -->
<!--            y = 750, -->
<!--            label = "+1") + -->
<!--   annotate("text", -->
<!--            x = as.Date("2020-05-30"), -->
<!--            y = 750, -->
<!--            label = "+2") + -->
<!--   annotate( -->
<!--     geom = "curve", -->
<!--     x = as.Date("2018-11-15"), -->
<!--     y = 800, -->
<!--     xend = as.Date("2020-05-15"), -->
<!--     yend = 750, -->
<!--     curvature = -.3, -->
<!--     arrow = arrow(length = unit(2, "mm")) -->
<!--   ) + -->
<!--   theme( -->
<!--     legend.position = "top", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   scale_fill_viridis_d(option = "plasma") -->

<!-- ### USE GRAPH OF TIMELINE -->
<!-- lds2 -->
<!-- ``` -->

<!-- ## Appendix 2: Background -->


<!-- New Zealand ranks among the world's most tolerant societies [@Oecd2011-qv]. However, Muslims are New Zealand's least accepted minority group [@Shaver2016-fs; @shaver2017news; @hawi2019terrorism; @yogeeswaran2019exploring; @greaves2020comparative; @sibley2020prejudice; @highland2019attitudes; @hawi2019terrorism]. -->

<!-- In the context of New Zealand history, the relatively high levels of prejudice against Muslim, as well as the confusion of Muslims with Arabs, might seem surprising. -->

<!-- First, New Zealand's cultural diversity exceeds that of Australia, the United Kingdom, France, Germany, the Netherlands, and Scandinavia. Muslims are only a small part of this diversity. In 2018, New Zealand's Muslim, just over 1.5% of the total population. The Islamic community has been present in New Zealand since at least 1874 (Shepard, 2006). The New Zealand Muslim community is of diverse ethnic and cultural origins --- of those that affiliated with Islam in 2013, 26.9% were born in Asia, 25.7% in New Zealand, 23.3% in the Middle East or Africa, and 21% in the Pacific Islands (Center, 2013). Thus, fewer than a quarter of New Zealand Muslims can be classified as 'Arab.' -->

<!-- <aside> -->
<!-- Colonial New Zealand state never adopted an official state religion, while principles of religious equality and the promotion of social harmony led to the formation of a secular state primary education system beginning in 1877. In such a setting where religious conflicts are few, anti-religious prejudice of any kind is anomalous. -->
<!-- </aside> -->

<!-- Another reason that anti-Muslim in New Zealand is puzzling is that New Zealand is one of the world's most socially progressive and tolerant societies [@Oecd2011-qv], which has a long tradition of religious tolerance and accommodation of religious diversity. -->

<!-- A final source of puzzlement about anti-Muslim prejudice in New Zealand is that there is no record of any extremist Muslim group in New Zealand, nor have there been any reported attacks of Muslims on non-Muslims By contrast many attacks against the Muslim minority were reported prior to 15 March 2019, when 51 Muslims were murdered at two mosques in a single day. Members of Islamic communities in New Zealand have long reported verbal and physical harassment, vandalism, negative media portrayal, and/or have faced difficulties in the labour market [\@ ](Shepard, 2012). Thus, while Muslims in New Zealand have a basis for concern about their experiences of anti-Muslim prejudice, there is no basis from in experience for anti-Muslim prejudice among the non-Muslim majority -->

<!-- ### Sources of anti-Muslim prejudice -->

<!-- In previous research, we found that levels of media exposure predicted lower warmth towards Muslims; notably, this effect held at both the low and high end of the political conservativism scale [@shaver2017news]. Whether changes in media coverage of Muslims contributed to rising Muslim acceptance following the attacks is a question that our future research will consider. -->

<!--  We also found that prior to the attacks, religiously identified New Zealanders were on average more accepting of Muslims [@Shaver2016-fs]. Whether this difference held after the attacks is another question that we will consider in future research. -->

<!-- ## Appendix 3: Prejudice trends from 2012-2020 reveal a longstanding "Muslim Acceptance Gap" -->

<!-- Figure \@ref(fig:warmthtime) shows the longer term trend warmth towards Muslims, begining in 2012, when the NZAVS first included questions about about attitudes to Muslims. As evident in the figure, despite gradually increasing warmth towards Muslims, the group as a whole has experienced greater prejudice than other groups. Prejudice of any kind, towards Muslims or other groups, should be addressed because prejudice unfairly affects life experiences for those who are the targets of it. Experiences of unfairness conflict with New Zealand's aspirations to extend manaakitanga, and whanaungatanga to all New Zealanders. -->

<!-- For more analysis of prejudice trends in New Zealand see: [@sibley2020prejudice] -->

<!-- ```{r include = FALSE, warmthtime, fig.width=12,  layout="l-body-outset", fig.height=12, fig.cap="\\label{fig:warmthtime} Within-person prejudice change pre/post attacks towards (a) Muslims, (b) Immigrants, (c) Māori, (d) NZ Europeans. Redline indicates mosque attacks. Greenline indicates maximum warmth to Muslims, which was strongly boosted post-attacks, yet lags behind other groups", cache = TRUE, fig.fullwidth = TRUE, include = TRUE} -->

<!-- ld <- ggplot(data = dt, -->
<!--              aes(x = yrs, -->
<!--                  y = Warm.Muslims)) -->

<!-- lds_0 <-ld + geom_line(alpha = .005) + -->
<!--   stat_summary( -->
<!--     geom = "point", -->
<!--     fun = mean, -->
<!--     size = .1, -->
<!--     alpha = .2 -->
<!--   ) + -->
<!--   geom_smooth(method ="gam" ) +  theme_minimal() + labs("")   + theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + scale_colour_viridis_d(option = "plasma") +   geom_vline(xintercept= 9.71, linetype="dashed", color = "red") + -->
<!--   geom_hline(yintercept= 4.395, color = "green") + -->
<!--   ylab("Warmth (1-7)") + -->
<!--   labs(title="Warmth to Muslims") # + -->
<!-- #  xlab("Years 2011-2020, N = 22,254") -->

<!-- li <- ggplot(data = di, -->
<!--              aes(x = yrs, -->
<!--                  y = Warm.Immigrants)) -->

<!-- li_0 <-li + geom_line(alpha = .005) + -->
<!--   stat_summary( -->
<!--     geom = "point", -->
<!--     fun = mean, -->
<!--     size = .1, -->
<!--     alpha = .2 -->
<!--   ) + -->
<!--   geom_smooth(method = "gam") + -->
<!--   theme_minimal() + labs("")   + theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + scale_colour_viridis_d(option = "plasma") + -->
<!--   geom_vline(xintercept= 9.71, linetype="dashed", color = "red") + -->
<!--   geom_hline(yintercept= 4.4, color = "green") + -->
<!--   ylab("Warmth (1-7)") + -->
<!--   labs(title="Warmth to Immigrants") #+ -->
<!--  # xlab("Years 2011-2020, N = 22,254") -->

<!-- ## indians -->
<!-- lm <- ggplot(data = dindians, -->
<!--              aes(x = yrs, -->
<!--                  y = Warm.Indians)) -->

<!-- lm_m <-lm + geom_line(alpha = .005) + -->
<!--   stat_summary( -->
<!--     geom = "point", -->
<!--     fun = mean, -->
<!--     size = .1, -->
<!--     alpha = .2 -->
<!--   ) + -->
<!--   geom_smooth( method = "gam" ) + -->
<!--   theme_minimal() + labs("")   + theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + scale_colour_viridis_d(option = "plasma") + -->
<!--   geom_vline(xintercept= 9.71, linetype="dashed", color = "red") + -->
<!--   geom_hline(yintercept= 4.4, color = "green") + -->
<!--   ylab("Warmth (1-7)") + -->
<!--   labs(title="Warmth to Indians") -->
<!--   #+ -->
<!--  # xlab("Years 2011-2020, N = 22,254") -->

<!-- # Chinese -->
<!-- lnz <- ggplot(data = dchinese, -->
<!--               aes(x = yrs, -->
<!--                   y = Warm.Chinese)) -->

<!-- lnz_0 <-lnz + geom_line(alpha = .005) + -->
<!--   stat_summary( -->
<!--     geom = "point", -->
<!--     fun = mean, -->
<!--     size = .1, -->
<!--     alpha = .2 -->
<!--   ) + -->
<!--   geom_smooth( method = "gam" ) + -->
<!--   theme_classic() + labs("")   + theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + scale_colour_viridis_d(option = "plasma") + -->
<!--   geom_vline(xintercept= 9.71, linetype="dashed", color = "red") + -->
<!--   geom_hline(yintercept= 4.4, color = "green") + -->
<!--   ylab("Warmth (1-7)") + -->
<!--   labs(title="Warmth to Chinese") + -->
<!--   xlab("Years 2011-2020, N = 22,254") -->

<!-- lds_0 + li_0 + lm_m + lnz_0 +  plot_layout(guides = 'collect', nrow = 1, byrow = FALSE) +   plot_annotation(title = "Timeline of attitudes to different groups in New Zealand; years 2011-2020: Source: NZAVS, N = 22,254", subtitle = "Green line = maximum level of warmth for Muslims, red line = Mosque attacks; Alpha for points on graph were set to .02 to avoid overplotting; method for estimation", tag_levels = 'a') -->

<!-- ``` -->

<!-- ```{r  modelspolitics,  cache = TRUE} -->

<!-- m6 <- lmer(Warm.Muslims ~  cons_s * Attack +  EthnicCats +  -->
<!--              a_s + -->
<!--              r_s + (1|Id) , # dependence owing to the week of response -->
<!--            data=km2) -->

<!-- p6 <- plot(ggeffects::ggpredict(m6, terms = c("Attack [all]", "cons_s[all]"), ci = .89)) + xlab("Conservativism") + ylab("Warmth Muslims") +  scale_colour_viridis_d() -->

<!-- p7 <- plot(ggeffects::ggpredict(m6, terms = c("cons_s[all]","Attack [all]"), ci = .89), add.data = TRUE, dot.alpha = 0.02, jitter = .2 ) + scale_y_continuous(limits = c(.5,7.5)) + -->
<!--   xlab("Political Conservativism (SD)") + ylab("Warmth Muslims (1-7") +  -->
<!--   labs(title = "Warmth to Muslims") + scale_colour_viridis_d()   + -->
<!--   theme( -->
<!--     # Change legend background color -->
<!--     # legend.background = element_rect(fill = "darkgray"), -->
<!--     #  legend.key = element_rect(fill = "lightblue", color = NA), -->
<!--     # Change legend key size and key width -->
<!--     legend.key.size = unit(0.2, "cm"), -->
<!--      legend.direction = "vertical",, -->
<!--     legend.key.width = unit(0.2, "cm"), -->
<!--   ) +  -->
<!--   guides(size = 1.5) -->

<!-- desc <- "Post Shooting Difference" -->

<!-- p71<-p7 + annotate("rect",  -->
<!--               xmin = 2.,  -->
<!--               xmax = 2.5,  -->
<!--               ymin = 3.5,  -->
<!--               ymax = 4.1, -->
<!--               alpha = .2,  -->
<!--               colour = "red") +  -->
<!--   annotate( -->
<!--     "rect", -->
<!--     xmin = -2., -->
<!--     xmax = -1.5, -->
<!--     ymin = 4.4, -->
<!--     ymax = 4.8, -->
<!--     alpha = .2, -->
<!--     colour = "red" -->
<!--   ) +  -->
<!--   annotate( -->
<!--     "text", -->
<!--     x = 0, -->
<!--     y = 7.2, -->
<!--     label = " Greater relative growth in  -->
<!--     acceptance among conservatives", -->
<!--     colour = "brown3" -->
<!--   ) +  -->
<!--   annotate( -->
<!--     geom = "curve", -->
<!--     x = -1, -->
<!--     y = 6.7, -->
<!--     xend = -1.75, -->
<!--     yend = 4.9, -->
<!--     curvature = 0, -->
<!--     arrow = arrow(length = unit(2, "mm")), -->
<!--     colour = "red" -->
<!--   ) + -->
<!--    annotate( -->
<!--     geom = "curve", -->
<!--     x = 1, -->
<!--     y = 6.7, -->
<!--     xend = 2.25, -->
<!--     yend = 4.2, -->
<!--     curvature = 0, -->
<!--     arrow = arrow(length = unit(2, "mm")), -->
<!--     colour = "red" -->
<!--   )  -->

<!-- ## Compare this to warmth to Maori -->
<!-- m8 <- lmer(Warm.Maori ~  cons_s * Attack +  EthnicCats +  -->
<!--              a_s + -->
<!--              r_s +(1|Id) , # dependence owing to the week of response -->
<!--            data=km2) -->

<!-- p8 <- plot(ggeffects::ggpredict(m8, terms = c("cons_s[all]","Attack [all]"), ci = .89),  -->
<!--           add.data = TRUE, dot.alpha = 0.02, jitter = .2 ) + scale_y_continuous(limits = c(.5,7.5)) + -->
<!--   xlab("Political Conservativism (SD)") + ylab("Warmth Māori (1-7") +  -->
<!--   labs(title = "Warmth to Māori") + scale_colour_viridis_d()+  -->
<!--     theme( -->
<!--     # Change legend background color -->
<!--     # legend.background = element_rect(fill = "darkgray"), -->
<!--     #  legend.key = element_rect(fill = "lightblue", color = NA), -->
<!--     # Change legend key size and key width -->
<!--     legend.key.size = unit(0.2, "cm"), -->
<!--     legend.direction = "vertical", -->
<!--     legend.key.width = unit(0.2, "cm") -->
<!--   )+  -->
<!--   guides(size = 1.5) -->

<!-- ## Warmth to NZEuro -->
<!-- m9 <- lmer(Warm.NZEuro ~  cons_s * Attack +  EthnicCats +  -->
<!--              a_s + -->
<!--              r_s +(1|Id) , # dependence owing to the week of response -->
<!--            data=km2) -->

<!-- p9 <- plot(ggeffects::ggpredict(m9, terms = c("cons_s[all]","Attack [all]"), ci = .89),  -->
<!--           add.data = TRUE, dot.alpha = 0.02, jitter = .2 ) + scale_y_continuous(limits = c(.5,7.5)) + -->
<!--   xlab("Political Conservativism (SD)") + ylab("Warmth NZ Europeans (1-7") +  -->
<!--   labs(title = "Warmth to NZ Europeans") + scale_colour_viridis_d() +  -->
<!--     theme( -->
<!--     # Change legend background color -->
<!--     # legend.background = element_rect(fill = "darkgray"), -->
<!--     #  legend.key = element_rect(fill = "lightblue", color = NA), -->
<!--     # Change legend key size and key width -->
<!--     legend.key.size = unit(0.2, "cm"), -->
<!--      legend.direction = "vertical", -->
<!--     legend.key.width = unit(0.2, "cm") -->
<!--   )+  -->
<!--   guides(size = 1.5) -->

<!-- m10 <- lmer(Warm.Immigrants ~  cons_s * Attack +  EthnicCats +  -->
<!--              a_s + -->
<!--              r_s +(1|Id) , # dependence owing to the week of response -->
<!--            data=km2) -->

<!-- p10 <- -->
<!--   plot( -->
<!--     ggeffects::ggpredict( -->
<!--       m10, -->
<!--       terms = c("cons_s[all]", "Attack [all]"), -->
<!--       ci = .89 -->
<!--     ), -->
<!--     add.data = TRUE, -->
<!--     dot.alpha = 0.02, -->
<!--     jitter = .2 -->
<!--   ) + scale_y_continuous(limits = c(.5, 7.5)) + -->
<!--   xlab("Political Conservativism (SD)") + ylab("Warmth Immigrants (1-7") + -->
<!--   labs(title = "Warmth to Immigrants") + scale_colour_viridis_d()+ -->
<!--   theme( -->
<!--     # Change legend background color -->
<!--     # legend.background = element_rect(fill = "darkgray"), -->
<!--     #  legend.key = element_rect(fill = "lightblue", color = NA), -->
<!--     # Change legend key size and key width -->
<!--     legend.key.size = unit(0.2, "cm"), -->
<!--     legend.key.width = unit(0.2, "cm"), -->
<!--     legend.direction = "vertical") + -->
<!--   guides(size = 1.5) + -->
<!--   annotate( -->
<!--     "rect", -->
<!--     xmin = 2., -->
<!--     xmax = 2.5, -->
<!--     ymin = 4.2, -->
<!--     ymax = 4.4, -->
<!--     alpha = .2, -->
<!--     colour = "red" -->
<!--   ) +  -->
<!--   annotate( -->
<!--     "rect", -->
<!--     xmin = -2., -->
<!--     xmax = -1.5, -->
<!--     ymin = 4.75, -->
<!--     ymax = 4.95, -->
<!--     alpha = .2, -->
<!--     colour = "red" -->
<!--   ) +  -->
<!--   annotate( -->
<!--     "text", -->
<!--     x = 0, -->
<!--     y = 7.2, -->
<!--     label = "Boost to Immigrant Warmth was linear across political conservativism", -->
<!--     colour = "brown3" -->
<!--   ) +  -->
<!--   annotate( -->
<!--     geom = "curve", -->
<!--     x = -1, -->
<!--     y = 6.7, -->
<!--     xend = -1.75, -->
<!--     yend = 4.95, -->
<!--     curvature = 0, -->
<!--     arrow = arrow(length = unit(2, "mm")), -->
<!--     colour = "red" -->
<!--   ) + -->
<!--    annotate( -->
<!--     geom = "curve", -->
<!--     x = 1, -->
<!--     y = 6.7, -->
<!--     xend = 2.25, -->
<!--     yend = 4.4, -->
<!--     curvature = 0, -->
<!--     arrow = arrow(length = unit(2, "mm")), -->
<!--     colour = "red" -->
<!--   )  -->
<!-- ``` -->

<!-- ## Appendix 4: Political conservatives also grew more accepting of Muslims after the 2019 Mosque attacks. -->

<!-- Generally, greater political conservativism predicts greater minority group prejudice. In absolute terms, however, growth in Muslim acceptance following the shootings was stronger at the conservative end of the scale (see Figure \@ref(fig:graphsmodelsPol).  -->

<!-- ```{r  graphsmodelsPol, fig.fullwidth = TRUE,  layout="l-body-outset", fig.width=12, fig.height=25, cache = TRUE, fig.cap="\\label{fig:graphsmodelsPol} Warmth to Muslims (y-axis) and other groups by political conservativism (x-axis) pre/post shootings (the solid lines). The shift betweenand the purple/blue lines (pre-attacks) and the yellow/green lines (post-attacks) shows the magnitude of growth in minority group acceptance. Here we plot all expected values of the model as points. The darkness of the areas on the graph reflect densities of responses. This approach allows us to visualise the variance around average responses. Results reveal that the mosque attacks led to a greater increase in warmth towards Muslims among political conservatives. However, this population had more headroom for growth in warmth. Whether this boost in Muslim warmth is sustained remains to be seen: (N = 11272, Years = 2017-2020, Source = New Zealand Attitudes and Values Study)", eval=TRUE, echo = FALSE} -->
<!-- lds4 <-  p71 + p10 + p8 + p9 +  plot_annotation(tag_levels = 'a') +   plot_layout(ncol = 2,  byrow = FALSE)  +  plot_layout(guides = 'collect') -->
<!-- lds4  -->
<!-- ``` -->


<!-- ## Appendix 5: Regression Discontinuity Analysis  -->


<!-- ```{r cache = TRUE} -->

<!-- df_rdd <- df %>% -->
<!--     dplyr::filter(Wave == 2018) %>% -->
<!--   dplyr::select( -->
<!--     Id, -->
<!--     Age, -->
<!--     Male, -->
<!--     TSCORE, -->
<!--     EthnicCats, -->
<!--     Warm.Overweight, -->
<!--     Warm.Elderly, -->
<!--     Warm.MentalIllness, -->
<!--     Warm.Muslims, -->
<!--     Warm.Immigrants, -->
<!--     Warm.Asians, -->
<!--     Warm.Refugees, -->
<!--     Wave, -->
<!--     Warm.Maori, -->
<!--     Warm.NZEuro, -->
<!--     Warm.Indians, -->
<!--     Warm.Chinese, -->
<!--     Warm.Refugees, -->
<!--     Warm.Pacific, -->
<!--     Muslim, -->
<!--     Euro, -->
<!--     Relid, -->
<!--     Religious, -->
<!--     Pol.Orient, -->
<!--     TSCORE, -->
<!--     WSCORE, -->
<!--     Terrorism.Anxiety, -->
<!--     KESSLER6sum, -->
<!--     KESSLER6, -->
<!--     BELONG, -->
<!--     PWI, -->
<!--     SWB.SoC01, -->
<!--     YearMeasured, -->
<!--     WSCORE -->
<!--   ) %>% -->
<!--   dplyr::filter(TSCORE >= 3395 & TSCORE <= 3695 -->
<!--   )%>% -->
<!--   dplyr::mutate(Pre_Post_attack = as.factor(ifelse( -->
<!--     TSCORE >= 3545, "Post_Attack", "Pre_Attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Neighbourhood_Community = SWB.SoC01) %>% -->
<!--   dplyr::mutate(Personal_Wellbeing = PWI) %>% -->
<!--   dplyr::mutate(Pre_Post_attack = forcats::fct_relevel(Pre_Post_attack, c("Pre_Attack", "Post_Attack"))) %>% -->
<!--   dplyr::mutate(days = as.integer(TSCORE), -->
<!--                 years = days / 365) %>% -->
<!--   dplyr::mutate(days_0 = as.integer(days - min(days))) %>% -->
<!--   dplyr::filter(Muslim == 0)%>% -->
<!--   dplyr::mutate(Timeline = make_date(year = 2009, month = 6, day = 30)+ TSCORE) -->


<!-- length(unique(df_rdd$Id)) -->
<!-- plot(df_rdd$days_0) -->

<!-- table1::table1(~ Age + Male + EthnicCats, data = df_rdd) -->




<!-- df_rdd2 <- df %>% -->
<!--     dplyr::filter(Wave == 2018) %>% -->
<!--   dplyr::select( -->
<!--     Id, -->
<!--     Age, -->
<!--     Male, -->
<!--     TSCORE, -->
<!--     EthnicCats, -->
<!--     Warm.Overweight, -->
<!--     Warm.Elderly, -->
<!--     Warm.MentalIllness, -->
<!--     Warm.Muslims, -->
<!--     Warm.Immigrants, -->
<!--     Warm.Asians, -->
<!--     Warm.Refugees, -->
<!--     Wave, -->
<!--     Warm.Maori, -->
<!--     Warm.NZEuro, -->
<!--     Warm.Indians, -->
<!--     Warm.Chinese, -->
<!--     Warm.Refugees, -->
<!--     Warm.Pacific, -->
<!--     Muslim, -->
<!--     Euro, -->
<!--     Relid, -->
<!--     Religious, -->
<!--     Pol.Orient, -->
<!--     TSCORE, -->
<!--     WSCORE, -->
<!--     Terrorism.Anxiety, -->
<!--     KESSLER6sum, -->
<!--     KESSLER6, -->
<!--     BELONG, -->
<!--     PWI, -->
<!--     SWB.SoC01, -->
<!--     YearMeasured, -->
<!--     WSCORE -->
<!--   ) %>% -->
<!--   dplyr::filter(TSCORE >= 3288 # July 1 2018 -->
<!--   )%>% -->
<!--   dplyr::mutate(Pre_Post_attack = as.factor(ifelse( -->
<!--     TSCORE >= 3545, "Post_Attack", "Pre_Attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Neighbourhood_Community = SWB.SoC01) %>% -->
<!--   dplyr::mutate(Personal_Wellbeing = PWI) %>% -->
<!--   dplyr::mutate(Pre_Post_attack = forcats::fct_relevel(Pre_Post_attack, c("Pre_Attack", "Post_Attack"))) %>% -->
<!--   dplyr::mutate(days = as.integer(TSCORE), -->
<!--                 years = days / 365) %>% -->
<!--   dplyr::mutate(days_0 = as.integer(days - min(days))) %>% -->
<!--   dplyr::filter(Muslim == 0)%>% -->
<!--   dplyr::mutate(Timeline = make_date(year = 2009, month = 6, day = 30)+ TSCORE) -->


<!-- length(unique(df_rdd$Id)) -->
<!-- plot(df_rdd$days_0) -->

<!-- table1::table1(~ Age + Male + EthnicCats, data = df_rdd) -->



<!-- # TERRORISM ANXIETY -->
<!-- df$YearMeasured -->
<!-- df_rdd3 <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1) %>% -->
<!--     dplyr::filter(Wave == 2016 | Wave == 2017 | Wave == 2018| Wave == 2019) %>% -->
<!--   dplyr::select( -->
<!--     TSCORE, -->
<!--     WSCORE, -->
<!--     Terrorism.Anxiety, -->
<!--     KESSLER6sum, -->
<!--     KESSLER6, -->
<!--     BELONG, -->
<!--     PWI, -->
<!--     SWB.SoC01, -->
<!--     YearMeasured, -->
<!--     WSCORE -->
<!--   ) %>% -->
<!--   droplevels() %>% -->
<!--    dplyr::mutate(Pre_Post_attack = as.factor(ifelse( -->
<!--     TSCORE >= 3545, "Post_Attack", "Pre_Attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_Post_attack = forcats::fct_relevel(Pre_Post_attack, c("Pre_Attack", "Post_Attack"))) %>% -->
<!--   dplyr::mutate(Timeline = make_date(year = 2009, month = 6, day = 30)+ TSCORE) -->

<!-- # long term k6 periodicity -->


<!-- # TERRORISM ANXIETY -->
<!-- df_rdd4 <- df %>% -->
<!--   dplyr::filter(YearMeasured == 1) %>% -->
<!--     dplyr::filter(Wave != 20099) %>% -->
<!--   dplyr::select( -->
<!--     TSCORE, -->
<!--     WSCORE, -->
<!--     Terrorism.Anxiety, -->
<!--     KESSLER6sum, -->
<!--     KESSLER6, -->
<!--     BELONG, -->
<!--     PWI, -->
<!--     SWB.SoC01, -->
<!--     YearMeasured, -->
<!--     WSCORE -->
<!--   ) %>% -->
<!--   droplevels() %>% -->
<!--    dplyr::mutate(Pre_Post_attack = as.factor(ifelse( -->
<!--     TSCORE >= 3545, "Post_Attack", "Pre_Attack" -->
<!--   ))) %>% -->
<!--   dplyr::mutate(Pre_Post_attack = forcats::fct_relevel(Pre_Post_attack, c("Pre_Attack", "Post_Attack"))) %>% -->
<!--   dplyr::mutate(Timeline = make_date(year = 2009, month = 6, day = 30)+ TSCORE) -->



<!-- #library(table1)  # make pretty tables quickly -->
<!-- #table1::table1(~Muslim|Wave, data = km, overall=F)# there are 31 muslims in 2017 -->
<!-- ``` -->


<!-- ```{r cache = TRUE} -->
<!-- ## RDD FULL SAMPLE -->


<!-- np <- -->
<!--   ggplot(data = df_rdd, -->
<!--          aes( -->
<!--            x = Timeline, -->
<!--            y = KESSLER6, -->
<!--            group = Pre_Post_attack, -->
<!--            colour = Pre_Post_attack -->
<!--          )) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_distress <- np + -->
<!--   geom_point(alpha = .03) + -->
<!--  # stat_smooth(method =  stats::loess) + -->
<!--    stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") + -->
<!--   labs(title = "Regression discontinuity attack shows little change in distress")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Kessler 6: scale 0-4")  + -->
<!--   xlab("Timeline: 2018-OCT-16 to 2019-AUG-12") -->

<!-- cd <- -->
<!--   change_distress + ggtitle("Regression Discontinuity Analysis of Kessler6 Distress Pre/Post Attacks") -->
<!-- cd -->


<!-- ## long trend -->

<!-- npk <- -->
<!--   ggplot(data = df_rdd4, -->
<!--          aes( -->
<!--            x = Timeline, -->
<!--            y = KESSLER6 -->
<!--          )) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_distressk <- npk + -->
<!--   geom_point(alpha = .03) + -->
<!--  # stat_smooth(method =  stats::loess) + -->
<!--    stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") + -->
<!--   labs(title = "Long term trend k6 distress")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Kessler 6: scale 0-4")  + -->
<!--   xlab("Timeline: 2018-OCT-16 to 2019-AUG-12") -->

<!-- cdk <- -->
<!--   change_distressk + ggtitle("Long term trend k6 distress") -->
<!-- cdk -->





<!-- #### Terr Anx -->





<!-- np2 <- -->
<!--   ggplot(data = df_rdd2, -->
<!--          aes( -->
<!--            x = Timeline, -->
<!--            y = Terrorism.Anxiety #, -->
<!--         #   group = Pre_Post_attack, -->
<!--          #  colour = Pre_Post_attack -->
<!--          )) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_distress2 <- np2 + -->
<!--   geom_point(alpha = .03) + -->
<!--  # stat_smooth(method =  stats::loess) + -->
<!--    stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") + -->
<!--   labs(title = "Regression discontinuity attack shows little change in distress")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Kessler 6: scale 0-4")  + -->
<!--   xlab("Timeline: 2018-JUL-01 to 2019-AUG-12") -->

<!-- cd2 <- -->
<!--   change_distress2 + ggtitle("Regression Discontinuity Analysis of Kessler6 Distress Pre/Post Attacks") -->
<!-- cd2 -->





<!-- np3 <- -->
<!--   ggplot( -->
<!--     data = df_rdd3, -->
<!--     aes( -->
<!--       x = Timeline, -->
<!--       y = Terrorism.Anxiety  -->
<!--     ) -->
<!--   ) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_ta3 <- np3 + -->
<!--   geom_point(alpha = .03) + -->
<!--   # stat_smooth(method =  stats::loess) + -->
<!--   stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") +  theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Kessler 6: scale 0-4")  + -->
<!--   xlab("Timeline:2016-2020") -->

<!-- cd3 <- -->
<!--   change_ta3 + ggtitle("Terrorism Anxiety 2016-2020") -->
<!-- cd3 -->



<!-- np3k <- -->
<!--   ggplot( -->
<!--     data = df_rdd3, -->
<!--     aes( -->
<!--       x = Timeline, -->
<!--       y = KESSLER6 , -->
<!--       group = Pre_Post_attack, -->
<!--       colour = Pre_Post_attack -->
<!--     ) -->
<!--   ) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_ta3l<- np3k + -->
<!--   geom_point(alpha = .03) + -->
<!--   # stat_smooth(method =  stats::loess) + -->
<!--   stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Kessler 6: scale 0-4")  + -->
<!--   xlab("Timeline:2016-2020") -->

<!-- np3k <- -->
<!--   change_ta3l + ggtitle("K6 Anxiety 2016-2020") -->
<!-- np3k -->

<!-- # library(splines) -->
<!-- # out<-glm( -->
<!-- #   KESSLER6 ~ bs(days_0), -->
<!-- #   data = df_rdd) -->
<!-- # -->
<!-- # summary(out) -->
<!-- # plot( -->
<!-- #   ggeffects::ggpredict(out, "days_0"), -->
<!-- #   add.data = TRUE, -->
<!-- #   dot.alpha = .01 -->
<!-- # ) -->

<!-- ## RDD FULL SAMPLE -->
<!-- np2 <- -->
<!--   ggplot( -->
<!--     data = df_rdd, -->
<!--     aes( -->
<!--       x = Timeline, -->
<!--       y = Terrorism.Anxiety, -->
<!--       group = Pre_Post_attack, -->
<!--       colour = Pre_Post_attack -->
<!--     ) -->
<!--   ) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_terror <- np2 + -->
<!--   geom_point(alpha = .03) + -->
<!--  # stat_smooth(method =  stats::loess) + -->
<!--   stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") + -->
<!--   labs(title = "Regression discontinuity attack shows greater change in terrorism anxiety")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Terrorism Anxiety: scale 1-7") + -->
<!--   xlab("Timeline: 2018-OCT-16 to 2019-AUG-12") -->

<!-- ct <- -->
<!--   change_terror +  ggtitle("Regression Discontinuity Analysis of Terrorism Anxiety Pre/Post Attacks") -->
<!-- ct -->
<!-- # library(splines) -->
<!-- # out2<-glm( -->
<!-- #   Terrorism.Anxiety ~ bs(days_0), -->
<!-- #   data = df_rdd) -->
<!-- # -->
<!-- # summary(out2) -->
<!-- # plot( -->
<!-- #   ggeffects::ggpredict(out2, "days_0"), -->
<!-- #   add.data = TRUE, -->
<!-- #   dot.alpha = .01 -->
<!-- # ) -->



<!-- np3 <- -->
<!--   ggplot( -->
<!--     data = df_rdd, -->
<!--     aes( -->
<!--       x = Timeline, -->
<!--       y = Neighbourhood_Community, -->
<!--       group = Pre_Post_attack, -->
<!--       colour = Pre_Post_attack -->
<!--     ) -->
<!--   ) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_belong <- np3 + -->
<!--   geom_point(alpha = .03) + -->
<!--  # stat_smooth(method =  stats::loess) + -->
<!--    stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") + -->
<!--   labs(title = "Regression discontinuity attack shows greater change in community belonging")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Sense of Neighbourhood Community: scale 1-7") + -->
<!--   xlab("Timeline: 2018-OCT-16 to 2019-AUG-12") -->

<!-- nc <- -->
<!--   change_belong + ggtitle("Regression Discontinuity Analysis of Neighbourhood Community Pre/Post Attacks") -->
<!-- nc -->



<!-- np4 <- -->
<!--   ggplot(data = df_rdd, -->
<!--          aes( -->
<!--            x = Timeline, -->
<!--            y = PWI, -->
<!--            group = Pre_Post_attack, -->
<!--            colour = Pre_Post_attack -->
<!--          )) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_pwi <- np4 + -->
<!--   geom_point(alpha = .03) + -->
<!--  # stat_smooth(method =  stats::loess) + -->
<!--    stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") + -->
<!--   labs(title = "Regression discontinuity attack shows greater change in Personal Wellbeing")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Personal Wellbeing: scale 1-7") + -->
<!--   xlab("Timeline: 2018-OCT-16 to 2019-AUG-12") -->

<!-- pwb <- -->
<!--   change_belong + ggtitle("Regression Discontinuity Analysis of Personal Wellbeing Pre/Post Attacks") -->

<!-- pwb -->


<!-- library(patchwork) -->

<!-- (ct  + cd) / (nc + pwb)  + plot_annotation( -->
<!--   title = "Specificity of Wellbeing/Distress Response", -->
<!--   subtitle = "Non-Muslims Distress Dimenisons Pre/Post Mosque Attacks,  N =  17228 -->
<!-- smooth = GAM (mgcv)", -->
<!-- tag_levels = "a" -->
<!-- ) + -->
<!--   plot_layout(guides = 'collect') -->



<!-- table1::table1( -->
<!--   ~ Age + Male + EthnicCats + Terrorism.Anxiety + KESSLER6 + Neighbourhood_Community + Personal_Wellbeing | -->
<!--     Pre_Post_attack, -->
<!--   data = df_rdd -->
<!-- ) -->

<!-- ``` -->




<!-- ```{r cache =TRUE} -->

<!-- npN <- -->
<!--   ggplot(data = df_rdd, -->
<!--          aes(x = Timeline, -->
<!--              y = KESSLER6)) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_distressN <- npN + -->
<!--   geom_point(alpha = .03) + -->
<!--   stat_smooth(method =  stats::loess) + -->
<!--   # stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") + -->
<!--   labs(title = "Regression discontinuity attack shows little change in distress")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Kessler 6: scale 0-4")  + -->
<!--   xlab("Timeline: 2018-OCT-16 to 2019-AUG-12") -->

<!-- cdN <- -->
<!--   change_distressN + ggtitle("Regression Discontinuity Analysis of Kessler6 Distress Pre/Post Attacks") -->
<!-- cdN -->
<!-- # library(splines) -->
<!-- # out<-glm( -->
<!-- #   KESSLER6 ~ bs(days_0), -->
<!-- #   data = df_rdd) -->
<!-- # -->
<!-- # summary(out) -->
<!-- # plot( -->
<!-- #   ggeffects::ggpredict(out, "days_0"), -->
<!-- #   add.data = TRUE, -->
<!-- #   dot.alpha = .01 -->
<!-- # ) -->

<!-- ## RDD FULL SAMPLE -->
<!-- np2N <- -->
<!--   ggplot(data = df_rdd, -->
<!--          aes(x = Timeline, -->
<!--              y = Terrorism.Anxiety)) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_terrorN <- np2N + -->
<!--   geom_point(alpha = .03) + -->
<!--   stat_smooth(method =  stats::loess) + -->
<!--   # stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") + -->
<!--   labs(title = "Regression discontinuity attack shows greater change in terrorism anxiety")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Terrorism Anxiety: scale 1-7") + -->
<!--   xlab("Timeline: 2018-OCT-16 to 2019-AUG-12") -->

<!-- ctN <- -->
<!--   change_terrorN +  ggtitle("Regression Discontinuity Analysis of Terrorism Anxiety Pre/Post Attacks") -->
<!-- ctN -->
<!-- # library(splines) -->
<!-- # out2<-glm( -->
<!-- #   Terrorism.Anxiety ~ bs(days_0), -->
<!-- #   data = df_rdd) -->
<!-- # -->
<!-- # summary(out2) -->
<!-- # plot( -->
<!-- #   ggeffects::ggpredict(out2, "days_0"), -->
<!-- #   add.data = TRUE, -->
<!-- #   dot.alpha = .01 -->
<!-- # ) -->



<!-- np3N <- -->
<!--   ggplot(data = df_rdd, -->
<!--          aes(x = Timeline, -->
<!--              y = Neighbourhood_Community,)) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_belongN <- np3N + -->
<!--   geom_point(alpha = .03) + -->
<!--   stat_smooth(method =  stats::loess) + -->
<!--   # stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") + -->
<!--   labs(title = "Regression discontinuity attack shows greater change in community belonging")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Sense of Neighbourhood Community: scale 1-7") + -->
<!--   xlab("Timeline: 2018-OCT-16 to 2019-AUG-12") -->

<!-- ncN <- -->
<!--   change_belongN + ggtitle("Regression Discontinuity Analysis of Neighbourhood Community Pre/Post Attacks") -->
<!-- ncN -->



<!-- np4N <- -->
<!--   ggplot(data = df_rdd, -->
<!--          aes(x = Timeline, -->
<!--              y = PWI)) + scale_fill_viridis_c(option = "plasma") -->
<!-- change_pwiN <- np4 + -->
<!--   geom_point(alpha = .03) + -->
<!--   stat_smooth(method =  stats::loess) + -->
<!--   # stat_smooth(method = "gam") + -->
<!--   theme_classic() + -->
<!--   scale_color_viridis_d(option = "plasma") + -->
<!--   labs(title = "Regression discontinuity attack shows greater change in Personal Wellbeing")  +   theme( -->
<!--     legend.position = "right", -->
<!--     legend.text = element_text(size = 6), -->
<!--     legend.title = element_text(color = "Black", size = 8) -->
<!--   ) + -->
<!--   ylab("Personal Wellbeing: scale 1-7") + -->
<!--   xlab("Timeline: 2018-OCT-16 to 2019-AUG-12") -->

<!-- pwbN <- -->
<!--   change_belongN + ggtitle("Regression Discontinuity Analysis of Personal Wellbeing Pre/Post Attacks") -->

<!-- pwbN -->


<!-- library(patchwork) -->

<!-- (ctN  + cdN) / (ncN + pwbN)  + plot_annotation( -->
<!--   title = "Specificity of Wellbeing/Distress Response", -->
<!--   subtitle = "Non-Muslims Distress Dimenisons Pre/Post Mosque Attacks,  N =  17228 -->
<!-- method = loess smooth", -->
<!-- tag_levels = "a" -->
<!-- ) + -->
<!--   plot_layout(guides = 'collect') -->



<!-- table1::table1( -->
<!--   ~ Age + Male + EthnicCats + Terrorism.Anxiety + KESSLER6 + Neighbourhood_Community + Personal_Wellbeing | -->
<!--     Pre_Post_attack, -->
<!--   data = df_rdd -->
<!-- ) -->


<!-- # Weekly counts -->

<!-- table1::table1(~ Terrorism.Anxiety|factor(WSCORE), data = df_rdd, transpose = TRUE) -->


<!-- table1::table1(~ Terrorism.Anxiety + Age + Male + EthnicCats|factor(WSCORE), data = df_rdd,  -->
<!--                transpose = TRUE) -->

<!-- library(naniar) -->

<!-- df_rdd_n <- df_rdd %>% -->
<!--   dplyr::select(Terrorism.Anxiety, KESSLER6, Neighbourhood_Community,Personal_Wellbeing) -->

<!-- vis_miss(df_rdd_n) -->
<!-- ``` -->


